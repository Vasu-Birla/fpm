
<!-- Header Start -->
<%- include('firmheader.ejs'); %>
<!-- Header End -->

<!-- Sidebar -->
<%- include('firmsidebar.ejs'); %>
<!-- Sidebar End -->

<!-- ========================
    Start Page Content
========================= -->
<div class="page-wrapper">

    <!-- Start Content -->
    <div class="content">

        <!-- Page Header -->
        <div class="mb-4 d-flex align-items-center justify-content-between">
            <h5 class="fw-bold mb-0 d-flex align-items-center"> 
                <a href="/firmstaff/documents" class="text-dark"> 
                    <i class="ti ti-chevron-left me-1"></i> Documents & E-Sign
                </a>
            </h5>
        </div>

        <div class="row gx-3">

            <!-- Upload Document Card -->
            <div class="col-lg-6 mb-2">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold">Upload Document</div>
                    <div class="card-body">
                        <form action="#" method="POST" enctype="multipart/form-data">

                            <!-- Case Select -->
                            <div class="mb-3">
                                <label for="doc_case_id" class="form-label">Case</label>
                                <select id="doc_case_id" name="case_id" class="form-select select2">
                                    <option selected disabled>Select Case</option>
                                    <option value="1">Case 1</option>
                                    <option value="2">Case 2</option>
                                </select>
                            </div>

                            <!-- Title -->
                            <div class="mb-3">
                                <label for="doc_title" class="form-label fw-medium">Title</label>
                                <input type="text" id="doc_title" name="title" class="form-control" placeholder="Document title" required>
                            </div>

                            <!-- Kind -->
                            <div class="mb-3">
                                <label for="doc_kind" class="form-label fw-medium">Kind</label>
                                <select id="doc_kind" name="kind" class="form-select select2" required>
                                    <option value="">Select Kind</option>
                                    <option value="general">General</option>
                                    <option value="evidence">Evidence</option>
                                    <option value="contract">Contract</option>
                                    <option value="pleading">Pleading</option>
                                    <option value="order">Order</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <!-- File Upload -->
                            <div class="mb-3">
                                <label for="doc_file" class="form-label fw-medium">File (PDF/DOCX/Image; Max 10 MB)</label>
                                <input type="file" id="doc_file" name="file" class="form-control" accept=".pdf,.docx,.jpg,.png" required>
                                <small class="text-muted">Allowed: PDF, DOCX, JPG, PNG. Max size: 10 MB.</small>
                            </div>

                            <!-- Access Level -->
                            <div class="mb-3">
                                <label class="form-label fw-medium">Access Level</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="access_level" id="FirmOnly" value="FirmOnly" checked>
                                    <label class="btn btn-outline-primary" for="FirmOnly">Firm Only</label>
                                    <input type="radio" class="btn-check" name="access_level" id="CaseTeam" value="CaseTeam">
                                    <label class="btn btn-outline-primary" for="CaseTeam">Case Team</label>
                                    <input type="radio" class="btn-check" name="access_level" id="ClientShared" value="ClientShared">
                                    <label class="btn btn-outline-primary" for="ClientShared">Client Shared</label>
                                </div>
                            </div>

                            <!-- Tags Input -->
                            <div class="mb-3">
                                <label for="tags" class="form-label fw-medium">Tags</label>
                                <input type="text" id="tags" name="tags" class="form-control" data-role="tagsinput" placeholder="Add tags">
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Upload</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- New Version + OCR + E-Sign Card -->
            <div class="col-lg-6 mb-2">

                <!-- E-Sign Envelope Card -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header fw-bold">Send for E-Signature</div>
                        <div class="card-body">
                            <form action="#" method="POST">
                                <div class="mb-3">
                                    <label for="provider" class="form-label fw-medium">Provider</label>
                                    <select id="provider" name="provider" class="form-select select2" required>
                                        <option value="docusign">DocuSign</option>
                                        <option value="hellosign">HelloSign</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="es_doc_id" class="form-label fw-medium">Document</label>
                                    <select id="es_doc_id" name="document_id" class="form-select select2" required>
                                        <option value="">Select Document</option>
                                        <option value="123">Contract - Client A</option>
                                        <option value="124">Order - Client B</option>
                                    </select>
                                </div>

                                <!-- Recipients Repeater -->
                                <div class="mb-3">
                                    <label class="form-label fw-medium">Recipients</label>
                                    <div id="recipients-container">
                                        <div class="row mb-2 recipient-item align-items-center">
                                            <div class="col-3">
                                                <select name="recipients[0][type]" class="form-select select2">
                                                    <option value="FirmUser">Firm User</option>
                                                    <option value="Client">Client</option>
                                                    <option value="External">External</option>
                                                </select>
                                            </div>
                                            <div class="col-3">
                                                <input type="text" name="recipients[0][id_email]" class="form-control" placeholder="ID / Email"/>
                                            </div>
                                            <div class="col-3">
                                                <input type="text" name="recipients[0][name]" class="form-control" placeholder="Name"/>
                                            </div>
                                            <div class="col-2">
                                                <select name="recipients[0][role]" class="form-select select2">
                                                    <option value="signer">Signer</option>
                                                    <option value="cc">CC</option>
                                                </select>
                                            </div>
                                            <div class="col-1">
                                                <button type="button" class="btn btn-danger btn-sm remove-recipient">Remove</button>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm" id="addRecipientBtn">Add Recipient</button>
                                </div>

                                <div class="mb-3">
                                    <label for="es_message" class="form-label">Message</label>
                                    <textarea id="es_message" name="message" class="form-control" placeholder="E-Sign request message"></textarea>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="send_now" name="send_now">
                                    <label class="form-check-label" for="send_now">Send Now</label>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="submit" class="btn btn-success">Send Envelope</button>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card mt-1">
                <div class="card-header fw-bold">Documents & E-Sign List</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="documentsTable" class="table table-striped table-bordered table-nowrap">
                                <thead>
                                    <tr>
                                        <th>Sr. No.</th>
                                        <th>Title</th>
                                        <th>Case</th>
                                        <th>Kind</th>
                                        <th>Filename</th>
                                        <th>Access Level</th>
                                        <th>Tags</th>
                                        <th>E-Sign Provider</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php
                                    // Example array for demo; replace with database
                                    $documents = [
                                        [
                                            'id' => 1,
                                            'title' => 'Contract A',
                                            'case' => 'Case 1',
                                            'kind' => 'contract',
                                            'filename' => 'contract_A.pdf',
                                            'access_level' => 'FirmOnly',
                                            'tags' => 'urgent, clientA',
                                            'provider' => 'docusign',
                                            'status' => 'Signed'
                                        ],
                                        [
                                            'id' => 2,
                                            'title' => 'Evidence Photos',
                                            'case' => 'Case 2',
                                            'kind' => 'evidence',
                                            'filename' => 'evidence_photos.zip',
                                            'access_level' => 'CaseTeam',
                                            'tags' => 'evidence, photos',
                                            'provider' => 'hellosign',
                                            'status' => 'Envelope Sent'
                                        ]
                                    ];
                                    $count = 1;
                                        foreach ($documents as $doc) {
                                            echo '<tr>';
                                            echo '<td>' . $count++ . '</td>';
                                            echo '<td>' . htmlspecialchars($doc['title']) . '</td>';
                                            echo '<td>' . htmlspecialchars($doc['case']) . '</td>';
                                            echo '<td>' . ucfirst(htmlspecialchars($doc['kind'])) . '</td>';
                                            echo '<td><a href="#uploads/' . htmlspecialchars($doc['filename']) . '" target="_blank">' . htmlspecialchars($doc['filename']) . '</a></td>';
                                            echo '<td>' . htmlspecialchars($doc['access_level']) . '</td>';
                                            echo '<td>' . htmlspecialchars($doc['tags']) . '</td>';
                                            echo '<td>' . htmlspecialchars($doc['provider']) . '</td>';
                                            echo '<td><span class="badge badge-soft-success">' . htmlspecialchars($doc['status']) . '</span></td>';
                                            echo '<td>
                                                <div class="d-flex align-items-center gap-1">
                                                    <a href="/firmstaff/documents-edit?id=' . $doc['id'] . '" class="btn btn-sm btn-outline-primary"><i class="ti ti-edit"></i></a>
                                                    <a href="javascript:void(0);" class="btn btn-sm btn-outline-danger delete-document-btn" data-id="' . $doc['id'] . '"><i class="ti ti-trash"></i></a>
                                                </div>
                                            </td>';
                                            echo '</tr>';
                                        }
                                    ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Content -->
</div>

<!-- ========================
    End Page Content
========================= -->


<!-- Footer Start -->
<%- include('firmfooter.ejs'); %>
<!-- Footer End -->

<script>
// Recipients repeater
document.addEventListener('DOMContentLoaded', function () {
    let recipientIndex = 1;
    const recipientsContainer = document.getElementById('recipients-container');
    document.getElementById('addRecipientBtn').addEventListener('click', () => {
        const recipientItem = document.createElement('div');
        recipientItem.classList.add('row', 'mb-2', 'recipient-item', 'align-items-center');
        recipientItem.innerHTML = `
            <div class="col-3">
                <select name="recipients[${recipientIndex}][type]" class="form-select">
                    <option value="FirmUser">Firm User</option>
                    <option value="Client">Client</option>
                    <option value="External">External</option>
                </select>
            </div>
            <div class="col-3">
                <input type="text" name="recipients[${recipientIndex}][id_email]" class="form-control" placeholder="ID / Email"/>
            </div>
            <div class="col-3">
                <input type="text" name="recipients[${recipientIndex}][name]" class="form-control" placeholder="Name"/>
            </div>
            <div class="col-2">
                <select name="recipients[${recipientIndex}][role]" class="form-select">
                    <option value="signer">Signer</option>
                    <option value="cc">CC</option>
                </select>
            </div>
            <div class="col-1">
                <button type="button" class="btn btn-danger btn-sm remove-recipient">Remove</button>
            </div>
        `;
        recipientsContainer.appendChild(recipientItem);
        recipientIndex++;
    });

    recipientsContainer.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-recipient')) {
            e.target.closest('.recipient-item').remove();
        }
    });
});
</script>

<script>
// Delete Document Record
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.delete-document-btn').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const docId = this.getAttribute('data-id');
            Swal.fire({
                title: 'Are you sure?',
                text: "This document will be permanently deleted.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
                customClass: {
                    confirmButton: 'swal2-confirm btn btn-danger ms-2',
                    cancelButton: 'swal2-cancel btn btn-secondary'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/firmstaff/documents-delete?id=' + docId;
                }
            });
        });
    });
});
</script>
