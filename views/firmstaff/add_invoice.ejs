
<!-- Header Start -->
<%- include('firmheader.ejs'); %>
<!-- Header End -->

<!-- Sidebar -->
<%- include('firmsidebar.ejs'); %>
<!-- Sidebar End -->
<!-- ========================
    Start Page Content
========================= -->
<div class="page-wrapper">

    <!-- Start Content -->
    <div class="content">

        <!-- row start -->
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <!-- page header start -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-0 d-flex align-items-center"> 
                        <a href="/firmstaff/invoice_list" class="text-dark"> 
                            <i class="ti ti-chevron-left me-1"></i>Add Invoice
                        </a>
                    </h5>
                </div>
                <!-- page header end -->

                <!-- Add Invoice Section -->
                <div class="card">
                  <div class="card-body">
                    <div id="invoiceApp">
                      <div class="row">
                        <div class="col-lg-4 border-end">
                          <div class="mb-3">
                            <label class="form-label fw-medium">Client</label>
                            <select data-ignore-kilvish="Yes" v-model="selectedClient" class="form-select">
                              <option value="">Select Client</option>
                              <% (clients || []).forEach(c => { %>
                                <option value="<%= c.client_id %>"><%= c.first_name %> <%= c.last_name %> (<%= c.email %>)</option>
                              <% }) %>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-medium">Invoice #</label>
                            <input data-ignore-kilvish="Yes" type="text" class="form-control" v-model="invoiceNumber" readonly>
                          </div>

                          <div class="mb-3">
                            <label class="form-label fw-medium">Product Type</label>
                            <select v-model="selectedProductType" class="form-select" @change="updateProductList">
                              <option value="service">Service</option>
                              <option value="product">Product</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-medium">Select Item</label>
                            <select data-ignore-kilvish="Yes" v-model="selectedProduct" class="form-select">
                              <option v-for="p in filteredProducts" :key="p.service_id" :value="p">
                                {{ p.name }} ({{ p.type }}) - {{ currencySymbol }}{{ p.unit_price }}
                              </option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <button class="btn btn-outline-primary w-100" @click="addItem" :disabled="!selectedProduct">Add Item</button>
                          </div>

                          <div class="mb-3">
                            <label class="form-label fw-medium">Payment Mode</label>
                            <div class="d-flex flex-wrap gap-2">
                              <label class="form-check">
                                <input data-ignore-kilvish="Yes" type="radio" class="form-check-input" value="cash" v-model="paymentMode"> Cash
                              </label>
                              <label class="form-check">
                                <input data-ignore-kilvish="Yes" type="radio" class="form-check-input" value="card_pos" v-model="paymentMode"> Card / POS
                              </label>
                              <label class="form-check">
                                <input data-ignore-kilvish="Yes" type="radio" class="form-check-input" value="bank_transfer" v-model="paymentMode"> Bank Transfer
                              </label>
                              <label class="form-check">
                                <input data-ignore-kilvish="Yes" type="radio" class="form-check-input" value="online_gateway" v-model="paymentMode"> Online Gateway
                              </label>
                              <label class="form-check">
                                <input data-ignore-kilvish="Yes" type="radio" class="form-check-input" value="cheque" v-model="paymentMode"> Cheque
                              </label>
                            </div>
                          </div>

                          <div class="mb-3">
                            <label class="form-label fw-medium">Currency</label>
                            <select v-model="currency" class="form-select">
                              <option value="USD">USD</option>
                              <option value="EUR">EUR</option>
                              <option value="GBP">GBP</option>
                              <option value="INR">INR</option>
                            </select>
                          </div>

                          <div class="mb-3">
                            <label class="form-label fw-medium">Payment Status</label>
                            <select v-model="paymentStatus" class="form-select" @change="updateDueDate">
                              <option value="paid">Paid</option>
                              <option value="partialPaid">Partial Paid</option>
                              <option value="pending">Pending</option>
                            </select>
                          </div>
                          <div class="mb-3" v-if="paymentStatus === 'partialPaid'">
                            <label class="form-label fw-medium">Partial Payment Amount</label>
                            <input type="number" min="0" step="1" class="form-control" v-model.number="partialPaymentAmount">
                          </div>
                          <div class="mb-3" v-if="paymentStatus === 'partialPaid' || paymentStatus === 'pending'">
                            <label class="form-label fw-medium">Due Date</label>
                            <input type="date" class="form-control" v-model="dueDate">
                          </div>

                          <div class="mb-3">
                            <label class="form-label fw-medium">Tax Rate (%)</label>
                            <input type="number" min="0" max="100" step="0.1" class="form-control" v-model.number="taxRate">
                          </div>
                          <div class="mb-3">
                            <label class="form-label fw-medium">Discount Rate (%)</label>
                            <input type="number" min="0" max="100" step="0.1" class="form-control" v-model.number="discountRate">
                          </div>
                        </div>

                        <div class="col-lg-8">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-semibold mb-0">Invoice Items</h6>
                            <small class="text-muted">{{ invoiceItems.length }} item(s)</small>
                          </div>
                          <div class="border rounded p-3 bg-light">
                            <div class="d-flex flex-column gap-2">
                              <div class="d-flex align-items-center justify-content-between border rounded p-2 bg-white" v-for="(item, idx) in invoiceItems" :key="idx">
                                <div>
                                  <div class="fw-semibold">{{ item.name }} - {{ currencySymbol }}{{ item.price }}</div>
                                  <div class="text-muted small">Tax: {{ currencySymbol }}{{ calculateTax(item) }} | Discount: {{ currencySymbol }}{{ calculateDiscount(item) }}</div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                  <button class="btn btn-sm btn-outline-secondary" @click="decrementQuantity(item)">-</button>
                                  <span>{{ item.quantity }}</span>
                                  <button class="btn btn-sm btn-outline-secondary" @click="incrementQuantity(item)">+</button>
                                  <button class="btn btn-sm btn-outline-danger" @click="deleteItem(item)"><i class="ti ti-trash"></i></button>
                                </div>
                              </div>
                              <div v-if="!invoiceItems.length" class="text-center text-muted">No items added yet.</div>
                            </div>
                          </div>

                          <div class="mt-3">
                            <div class="card shadow-sm border-0 bg-light">
                              <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                  <span class="text-uppercase small text-muted fw-semibold">Invoice Summary</span>
                                  <span class="badge bg-primary text-white">Live</span>
                                </div>
                                <div class="d-flex justify-content-between py-1 border-bottom">
                                  <span>Subtotal</span><span class="fw-semibold">{{ currencySymbol }}{{ calculateInvoiceSubtotal() }}</span>
                                </div>
                                <div class="d-flex justify-content-between py-1 border-bottom">
                                  <span>Discount</span><span class="text-success">- {{ currencySymbol }}{{ calculateInvoiceDiscount() }}</span>
                                </div>
                                <div class="d-flex justify-content-between py-1 border-bottom">
                                  <span>Tax</span><span class="fw-semibold">{{ currencySymbol }}{{ calculateInvoiceTax() }}</span>
                                </div>
                                <div class="d-flex justify-content-between py-2 border-bottom fw-bold">
                                  <span>Grand Total</span><span>{{ currencySymbol }}{{ calculateGrandTotal() }}</span>
                                </div>
                                <div class="d-flex justify-content-between py-2 border-bottom">
                                  <span>Partial Payment</span><span class="text-warning">- {{ currencySymbol }}{{ partialPaymentAmount }}</span>
                                </div>
                                <div class="mt-3 p-3 rounded bg-white border">
                                  <div class="text-uppercase small text-muted fw-semibold mb-1">Net Pay / Due</div>
                                  <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold fs-5">Amount Due</span>
                                    <span class="fw-bold" style="font-size: 2rem; color: #0d6efd;">{{ currencySymbol }}{{ calculateNetPay() }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="mt-3">
                            <label class="form-label fw-medium">Notes</label>
                            <textarea class="form-control" rows="3" v-model="notes"></textarea>
                          </div>

                          <div class="mt-3 d-flex justify-content-end gap-2">
                           
                            <button class="btn btn-primary" @click="saveInvoice">Save & Send</button>
                          </div>
                        </div>
                      </div>
                      <!-- Hidden preview for html2pdf (inside Vue root) -->
                      <div id="invoicePreview" style="position:absolute; left:-9999px; top:-9999px; width:900px;">
                        <div style="font-family:Arial,sans-serif; border:1px solid #e5e7eb; padding:18px; border-radius:10px;">
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <div>
                              <div style="font-size:22px; font-weight:700;">Invoice</div>
                              <div style="color:#6b7280;">#{{ invoiceNumber }}</div>
                            </div>
                            <div style="background:#0e4fbf; color:#fff; padding:6px 12px; border-radius:20px; font-weight:600;">
                              {{ paymentStatus === 'paid' ? 'PAID' : (paymentStatus === 'partialPaid' ? 'PARTIAL' : 'PENDING') }}
                            </div>
                          </div>
                          <div style="display:flex; gap:16px; margin-bottom:12px;">
                            <div style="flex:1;">
                              <div style="color:#6b7280; font-size:12px;">Bill To</div>
                              <div style="font-weight:600;">{{ (clients.find(c => c.client_id == selectedClient)?.first_name || '') + ' ' + (clients.find(c => c.client_id == selectedClient)?.last_name || '') }}</div>
                              <div style="color:#6b7280;">{{ clients.find(c => c.client_id == selectedClient)?.email || '' }}</div>
                            </div>
                            <div style="flex:1;">
                              <div style="color:#6b7280; font-size:12px;">Dates</div>
                              <div>Created: {{ new Date().toLocaleDateString() }}</div>
                              <div v-if="dueDate">Due: {{ dueDate }}</div>
                            </div>
                          </div>
                          <table style="width:100%; border-collapse: collapse;">
                            <thead>
                              <tr>
                                <th style="text-align:left; border:1px solid #e5e7eb; padding:8px;">Item</th>
                                <th style="text-align:right; border:1px solid #e5e7eb; padding:8px;">Qty</th>
                                <th style="text-align:right; border:1px solid #e5e7eb; padding:8px;">Price</th>
                                <th style="text-align:right; border:1px solid #e5e7eb; padding:8px;">Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="item in invoiceItems" :key="item.service_id">
                                <td style="border:1px solid #e5e7eb; padding:8px;">{{ item.name }}</td>
                                <td style="border:1px solid #e5e7eb; padding:8px; text-align:right;">{{ item.quantity }}</td>
                                <td style="border:1px solid #e5e7eb; padding:8px; text-align:right;">{{ currencySymbol }}{{ item.price }}</td>
                                <td style="border:1px solid #e5e7eb; padding:8px; text-align:right;">{{ currencySymbol }}{{ calculateSubtotal(item) }}</td>
                              </tr>
                            </tbody>
                          </table>
                          <div style="margin-top:12px; width:300px; margin-left:auto;">
                            <div style="display:flex; justify-content:space-between; padding:6px 0;"><span>Subtotal</span><span>{{ currencySymbol }}{{ calculateInvoiceSubtotal() }}</span></div>
                            <div style="display:flex; justify-content:space-between; padding:6px 0;"><span>Discount ({{ discountRate }}%)</span><span>-{{ currencySymbol }}{{ calculateInvoiceDiscount() }}</span></div>
                            <div style="display:flex; justify-content:space-between; padding:6px 0;"><span>Tax ({{ taxRate }}%)</span><span>{{ currencySymbol }}{{ calculateInvoiceTax() }}</span></div>
                            <div style="display:flex; justify-content:space-between; padding:6px 0; font-weight:700;"><span>Grand Total</span><span>{{ currencySymbol }}{{ calculateGrandTotal() }}</span></div>
                            <div style="display:flex; justify-content:space-between; padding:6px 0;"><span>Partial Payment</span><span>-{{ currencySymbol }}{{ partialPaymentAmount }}</span></div>
                            <div style="display:flex; justify-content:space-between; padding:6px 0; font-weight:700;"><span>Net Due</span><span>{{ currencySymbol }}{{ calculateNetPay() }}</span></div>
                          </div>
                          <div v-if="notes" style="margin-top:10px; color:#4b5563;">Notes: {{ notes }}</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- /Add Invoice Section -->




                
            </div>
        </div>
        <!-- row end -->               
        
    </div>
    <!-- End Content -->

</div>

<!-- ========================
    End Page Content
========================= -->


<!-- Footer Start -->
<%- include('firmfooter.ejs'); %>
<!-- Footer End -->

<script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
  const fx = window.axiosElaw || window.axios || null;
  const servicesData = <%- JSON.stringify(services || []) %>;
  const clientsData = <%- JSON.stringify(clients || []) %>;

  new Vue({
    el: '#invoiceApp',
    data: {
      clients: clientsData,
      services: servicesData,
      selectedClient: '',
      selectedProductType: 'service',
      selectedProduct: null,
      invoiceItems: [],
      paymentMode: 'cash',
      paymentStatus: 'pending',
      taxRate: 10,
      discountRate: 0,
      partialPaymentAmount: 0,
      selectedPatientContact: '',
      selectedPatientAddress: '',
      invoiceNumber: '',
      currency: 'USD',
      dueDate: '',
      notes: '',
      sendNow: true,
      sending: false,
      currencySymbols: { USD: '$', EUR: 'EUR ', GBP: 'GBP ', INR: 'INR ' },
    },
    computed: {
      filteredProducts() {
        return this.services.filter(p => p.type === this.selectedProductType);
      },
      currencySymbol() {
        return this.currencySymbols[this.currency] || '$';
      },
    },
    methods: {
      generateInvoiceNumber() {
        this.invoiceNumber = Math.floor(1000000000 + Math.random() * 9000000000).toString();
      },
      updateProductList() {
        if (this.filteredProducts.length) {
          this.selectedProduct = this.filteredProducts[0];
        } else {
          this.selectedProduct = null;
        }
      },
      addItem() {
        if (!this.selectedProduct) return;
        const existing = this.invoiceItems.find(i => i.service_id === this.selectedProduct.service_id);
        if (existing) {
          existing.quantity++;
        } else {
          this.invoiceItems.push({
            service_id: this.selectedProduct.service_id,
            name: this.selectedProduct.name,
            price: Number(this.selectedProduct.unit_price) || 0,
            quantity: 1,
            type: this.selectedProduct.type || 'service',
          });
        }
      },
      incrementQuantity(item) {
        item.quantity++;
      },
      decrementQuantity(item) {
        if (item.quantity > 1) item.quantity--;
      },
      deleteItem(item) {
        const idx = this.invoiceItems.indexOf(item);
        if (idx >= 0) this.invoiceItems.splice(idx, 1);
      },
      calculateSubtotal(item) {
        return +(item.quantity * item.price).toFixed(2);
      },
      calculateTax(item) {
        return +(this.calculateSubtotal(item) * (this.taxRate / 100)).toFixed(2);
      },
      calculateDiscount(item) {
        return +(this.calculateSubtotal(item) * (this.discountRate / 100)).toFixed(2);
      },
      calculateInvoiceSubtotal() {
        return this.invoiceItems.reduce((t, i) => t + this.calculateSubtotal(i), 0).toFixed(2);
      },
      calculateInvoiceDiscount() {
        const sub = parseFloat(this.calculateInvoiceSubtotal()) || 0;
        return +(sub * (this.discountRate / 100)).toFixed(2);
      },
      calculateInvoiceTax() {
        const sub = parseFloat(this.calculateInvoiceSubtotal()) || 0;
        const discount = parseFloat(this.calculateInvoiceDiscount()) || 0;
        return +(((sub - discount) * (this.taxRate / 100))).toFixed(2);
      },
      calculateGrandTotal() {
        const sub = parseFloat(this.calculateInvoiceSubtotal()) || 0;
        const discount = parseFloat(this.calculateInvoiceDiscount()) || 0;
        const tax = parseFloat(this.calculateInvoiceTax()) || 0;
        return +(sub - discount + tax).toFixed(2);
      },
      calculateNetPay() {
        const grand = this.calculateGrandTotal();
        const net = Math.max(0, grand - (Number(this.partialPaymentAmount) || 0));
        return +net.toFixed(2);
      },
      updateDueDate() {
        if (this.paymentStatus === 'paid') {
          this.dueDate = '';
          this.partialPaymentAmount = 0;
        }
      },
      async saveInvoice() {
        if (!fx) return alert('Axios not available');
        if (!this.selectedClient) return (window.kilToast ? kilToast.danger('Select a client') : alert('Select a client'));
        if (!this.invoiceItems.length) return (window.kilToast ? kilToast.danger('Add at least one item') : alert('Add at least one item'));

        this.sending = true;
        const payload = {
          client_id: this.selectedClient,
          due_date: this.dueDate || null,
          currency: this.currency || 'USD',
          notes: this.notes || '',
          invoice_number: this.invoiceNumber,
          items: this.invoiceItems.map(i => ({
            service_id: i.service_id || null,
            description: i.name,
            quantity: i.quantity,
            unit_price: i.price,
            type: i.type || 'service',
          })),
          send_now: true,
          tax_rate: this.taxRate,
          discount_rate: this.discountRate,
          payment_status: this.paymentStatus,
          payment_mode: this.paymentMode,
          partial_payment: this.partialPaymentAmount,
        };

        try {
          const { data } = await fx.post('/firmstaff/invoices', payload);
          if (data?.success) {
            if (window.kilToast) kilToast.success('Invoice saved'); else alert('Invoice saved');
            if (data.pdf_url) {
              window.open(data.pdf_url, '_blank');
            } else if (data.pdf_key) {
              // fallback: fetch presigned download
              try {
                const dl = await fx.get(`/firmstaff/invoices/${data.invoice?.invoice_id}/download`);
                if (dl?.data?.url) window.open(dl.data.url, '_blank');
              } catch (e) {
                console.error('Download fallback error', e);
              }
            }
          } else {
            const msg = data?.message || 'Failed to save invoice';
            if (window.kilToast) kilToast.danger(msg); else alert(msg);
          }
        } catch (err) {
          console.error(err);
          const msg = err?.response?.data?.message || err.message || 'Failed to save invoice';
          if (window.kilToast) kilToast.danger(msg); else alert(msg);
        } finally {
          this.sending = false;
        }
      },
    },
    mounted() {
      this.generateInvoiceNumber();
      this.updateProductList();
    },
  });
</script>
