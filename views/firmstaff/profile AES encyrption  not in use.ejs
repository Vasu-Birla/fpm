<!-- Header Start -->
<%- include('firmheader.ejs'); %>
  <!-- Header End -->



  <!-- Sidebar scroll-->
  <%- include('firmsidebar.ejs'); %>
    <!-- End Sidebar scroll-->


    <div class="container">
      <div class="page-inner">
        <div class="page-header">
          <h3 class="fw-bold mb-3">Profile</h3>
          <ul class="breadcrumbs mb-3">
            <li class="nav-home">
              <a href="/firmstaff">
                <i class="icon-home"></i>
              </a>
            </li>
            <li class="separator">
              <i class="icon-arrow-right"></i>
            </li>
            <li class="nav-item">
              <a href="/firmstaff/profile">Firm Profile</a>
            </li>
          </ul>
        </div>
        <div class="row">
          <div class="col-md-4">
            <!--   ------ Start  Kil profile pic  -------   -->

            <!-- Profile Image -->
            <div id="successMessage" class="alert alert-success d-none">
              Profile picture updated successfully!
            </div>

            <div id="errorMessage" class="alert alert-danger d-none">
              Error updating profile picture. Please try again.
            </div>
            <div id="errmsg1"></div>

            <div class="card card-primary card-outline" >
              <div class="card-body box-profile text-center" >
                <div class="profile-pic_kil  mt-3 " >
                  <label class="-label" for="file">
                    <span class="glyphicon glyphicon-camera"></span>
                    <!-- <span>Change Image</span> -->
                  </label>
                  <input id="file" type="file" data-kilvish-file="image" />
                  <!-- <img  src="<%= loggeduser.avatar %>" id="output" alt="Change" width="200" /> -->
                



                   <img src="/secure/file_stream?s3key=<%= encodeURIComponent(loggeduser.avatar) %>" id="output" alt="Change" width="200" /> 
                  
                </div>

                <h3 class="profile-username text-center">
                  <%= loggeduser.first_name %>
                    <%= loggeduser.last_name %>
                </h3>
                <p class="text-center">Adminstration</p>


              </div>
            </div>
            <!-- Profile Image -->




            <p style="color: gray; text-align: left;">Choose a nice & professional picture to get more interviews! </p>
            &nbsp;

            <!--   ------ END Kil profile pic  -------   -->

          </div>

          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                  <li class="nav-item">
                    <a class="nav-link active" href="#edit-profile" data-bs-toggle="tab">Profile Details</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#change-password" data-bs-toggle="tab">Change Password</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#multifact" data-bs-toggle="tab">MFA (Multi Factor Authentication)</a>
                  </li>
                </ul>
              </div>
              <div class="card-body">
 
                      <div class="tab-content">
                        <!-- Edit Profile Tab -->
                        <div class="tab-pane active" id="edit-profile">
                          <form method="post" id="kilform">

                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="row">
                              <div class="col-md-6">
                                 <label for="first_name">First Name</label>
                                <div class="form-group">
                                 
                                  <input type="text" class="form-control" placeholder="First Name" name="first_name"
                                    value="<%= loggeduser.first_name %>" required>
                                </div>
                              </div>
                              <div class="col-md-6">
                                 <label for="last_name">Last Name</label>

                                <div class="form-group">
                                 
                                  <input type="text" class="form-control" placeholder="Last Name" name="last_name"
                                    value="<%= loggeduser.last_name %>" required>
                                </div>

                              </div>
                              <div class="col-md-6">
                                 <label for="email">Email</label>
                                <div class="form-group">
                                 
                                  <input type="email" class="form-control" placeholder="Email" name="email"
                                    value="<%= loggeduser.email %>" required>
                                </div>
                              </div>


                              <div class="col-md-6">
                                <label for="full_contact">Phone</label>
                                      <div class="form-group kiltel-phone-wrap">
                                        
                                         <button type="button" class="kiltel-country-trigger"></button>
                                                    <input type="tel" class="form-control" value="<%= loggeduser.full_contact %>" data-kilvish-preferred="JM"  data-kilvish-tel id="kilvishcontact" name="full_contact" placeholder="Enter mobile number" data-kiltel-init="JM" data-ignore-kilvish="yes" data-kiltel-validation="yes"  required>
                                                     


                                        <input type="hidden" id="country_code" name="country_code">
                                        <input type="hidden" id="contact" name="contact">
                                      </div>
                                    
                                  <div id="kiltel-error" style="color:red; font-size:0.93em; margin-top:5px;"></div>
                              </div>



                            </div>
                            <div class="text-end mt-3">
                              <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                          </form>
                        </div>

                        <!-- Change Password Tab -->
                        <div class="tab-pane" id="change-password">
                          <form method="post" id="kilform2" action="/firmstaff/changepass">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                                        <input type="hidden" id="encryptedOpass" name="opass">
                                        <input type="hidden" id="encryptedNpass" name="npass">
                                        <input type="hidden" id="encryptedCpass" name="cpass">


                                    <div class="mb-3">
                            <label class="form-label fw-medium">Current Password</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light"><i class="ti ti-lock text-primary"></i></span>
                              <input type="password" data-ignore-kilvish="Yes"  id="opass" data-kileye-color="#001489" class="form-control" placeholder="Old password" required>
                            </div>
                          </div>

                 
                                <div class="mb-3">
                            <label class="form-label fw-medium">New Password</label>
                            <div class="input-group">
                              <span class="input-group-text bg-light"><i class="ti ti-lock text-primary"></i></span>
                              <input type="password"  id="npass" data-kileye-color="#001489" class="form-control" placeholder="New password" required>
                            </div>
                          </div>

                              <div class="mb-3">
                                <label class="form-label fw-medium">Confirm New Password</label>
                                <div class="input-group">
                                  <span class="input-group-text bg-light"><i class="ti ti-lock-check text-primary"></i></span>
                                  <input data-ignore-kilvish="Yes" data-kileye-color="#001489" type="password" id="cpass" class="form-control" placeholder="Confirm new password" required>
                                </div>
                              </div>



                            <div class="text-end mt-3">
                              <button type="submit" class="btn btn-primary">Update Password</button>
                            </div>
                          </form>

                        </div>

                        <!-- MFA Tab -->
                        <div class="tab-pane" id="multifact">


                          <!-- ----------- START KIL-STEP 2-FACTOR AUTHENTICATION ---------------- -->
                          <div class="row">
                            <!-- row start  -->



                            <div class="col-md-6">


                              <div class="status-container" data-user-id="<%= loggeduser.staff_id %>"
                                data-user-status="<%= loggeduser.two_step_verification %>">





                                <% if (loggeduser.two_step_verification==='On' ) { %>
                                  <span class="badge badge-soft-info">Activated</span>
                                  <% } else if (loggeduser.two_step_verification==='Pending' ) { %>
                                    <span class="badge badge-soft-warning">Pending</span>
                                    <% } else { %>
                                      <span class="badge badge-soft-danger">De-activated</span>
                                      <% } %>

                                        <p id="2fa_msg"
                                          style="color: <%= loggeduser.two_step_verification === 'On' ? 'rgb(230, 20, 20)' : 'green' %>">
                                        </p>

                              </div>

                            </div>

                            <div class="col-md-6">


                              <% if (loggeduser.two_step_verification==='On' ) { %>
                                <a href="javascript:void(0)"
                                  onclick="on_off_multifactor('Off', '<%= loggeduser.first_name %>')"
                                  title="Turn Off">
                                  <span class="text-soft-danger">Turn Off</span>
                                </a>
                                <% } else { %>
                                  <a href="javascript:void(0)"
                                    onclick="on_off_multifactor('On', '<%= loggeduser.first_name %>')"
                                    title="Activate">
                                    <span class="text-soft-info">Turn On</span>
                                  </a>
                                  <% } %>


                            </div>

                            <!-- row end  -->
                          </div>
                          <!-- ----------- END KIL-STEP 2-FACTOR AUTHENTICATION ---------------- -->



                        </div>



                      </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Kiltel Phone Input -->
<input type="tel" id="hidden-iti-input" style="display:none;">
<!-- Kiltel Phone Input -->

    <!-- Footer Start -->
    <%- include('firmfooter.ejs'); %>
      <!-- Footer End -->








      <script>



        document.addEventListener("DOMContentLoaded", function () {
          //  document.cookie = 'staff_id'+'=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.cookie = 'sscl_msg' + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/';
          document.cookie = 'sscl_msg' + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          //document.cookie = 'sscl_msg_id'+'=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';

        });




       


            //============   Encrypt password before form submission
      document.getElementById('kilform2').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent immediate form submission

                const opass = document.getElementById('opass').value;
                const npass = document.getElementById('npass').value;
                const cpass = document.getElementById('cpass').value;

                document.getElementById('encryptedOpass').value = encrypt64(opass);
                document.getElementById('encryptedNpass').value = encrypt64(npass);
                document.getElementById('encryptedCpass').value = encrypt64(cpass);

                this.submit();
            });



            // document.getElementById('kilform').addEventListener('submit', function (event) {
            //     event.preventDefault(); // Prevent immediate form submission

            //     const username = document.getElementById('username').value;
            //     const email = document.getElementById('email').value;
              

            
            //     document.getElementById('encryptedUsername').value = encrypt64(username);
            //     document.getElementById('encryptedEmail').value = encrypt64(email);

            //     this.submit();
            // });

          function encrypt64(text) {
                 

              
                   const ENCRYPTION_SECRET_KEY = "<%= process.env.ENCRYPTION_SECRET_KEY %>";           
                  
                  // Encrypt text using AES and the secret key
                  const encrypted = CryptoJS.AES.encrypt(text, ENCRYPTION_SECRET_KEY).toString();

                  return encrypted; // Return encrypted password
              }

           //============   Encrypt password before form submission


    




        //====================== Profile Picture Updation with cropper ========================================


        document.getElementById('file').addEventListener('change', function (event) {

          loadFile(event)
        })



        var loadFile = function (event) {
          const inputField = event.target;
          const errorMessageDiv = document.getElementById('errmsg1');
          const file1 = inputField.files[0];  // Getting the file from the input field

          const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/tiff', 'image/webp', 'image/svg+xml']; // Define allowed image file types

          if (!validImageTypes.includes(file1.type)) {
            // Show error message and clear the input field
            errorMessageDiv.textContent = 'Please select a valid image file (JPEG or PNG)!';
            errorMessageDiv.style.color = 'red';
            inputField.value = ''; // Clear the input field
          } else {
            // Clear error message
            errorMessageDiv.textContent = '';

            // Ensure that file is valid before proceeding
            const file = inputField.files[0]; // Correct way to get the file
            if (!file) {
              console.error("No file selected.");
              return; // Exit if there's no file selected
            }

            // Create a FileReader to read the file
            var reader = new FileReader();
            reader.onload = function (e) {
              let cropper; // Declare cropper here so that it stays in scope for the preConfirm function

              Swal.fire({
                title: 'Crop Your Image',
                html: '<div style="width:100%; text-align:center;"><img id="image-to-crop" style="max-width:100%;"></div>',
                didOpen: () => {
                  const img = document.getElementById('image-to-crop');
                  img.src = e.target.result;
                  cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                  });
                },
                showCancelButton: true,
                confirmButtonText: 'Crop & Upload',
                preConfirm: () => {
                  return new Promise((resolve, reject) => {
                    if (!cropper) {
                      reject("Cropper instance is undefined");
                    }
                    const canvas = cropper.getCroppedCanvas();
                    canvas.toBlob((blob) => {
                      resolve(blob);
                    });
                  });
                },
              }).then((result) => {
                if (result.isConfirmed && result.value) {
                  const croppedImageBlob = result.value;

                  // Set the cropped image blob as the new file input value
                  const croppedFile = new File([croppedImageBlob], "cropped-image.png", { type: "image/png" });
                  const dataTransfer = new DataTransfer();
                  dataTransfer.items.add(croppedFile); // Adds the cropped image as a new file item
                  inputField.files = dataTransfer.files; // Update the file input with the cropped image

                  // Update the preview image immediately after cropping
                  const image = document.getElementById("output");
                  image.src = URL.createObjectURL(croppedFile);

                  // Create a FormData object to send the file
                  var formData = new FormData();
                  formData.append("image", croppedFile); // Use the name "profileImage" to match your server's expectations

                  // Send the AJAX request
                  $.ajax({
                    url: "/firmstaff/update_admin_pic", // Replace with your actual API endpoint URL
                    type: "POST",
                    headers: { 'CSRF-Token': csrfToken },
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                      if (response.msg == 'success') {
                        $("#successMessage").removeClass("d-none");
                        $("#errorMessage").addClass("d-none");
                      } else {
                        $("#errorMessage").removeClass("d-none");
                        $("#successMessage").addClass("d-none");
                      }
                    },
                    error: function (error) {
                      $("#errorMessage").removeClass("d-none");
                      $("#successMessage").addClass("d-none");
                    },
                  });
                }
              }).catch((err) => {
                console.error(err); // Log any errors that occur in the preConfirm process
              });
            };

            // Ensure file is valid before proceeding
            if (file) {
              reader.readAsDataURL(file);
            } else {
              console.error("File is not valid.");
            }
          }
        };



        //====================== End Profile Picture Updation with cropper =====================================






        function on_off_multifactor_working(newStatus, username) {


          event.preventDefault();
          var action;
          if (newStatus == 'Off') {
            action = 'Deactivated'
          } else {
            action = 'activated '
          }


       
          const pmsgElement = document.getElementById(`2fa_msg`);

          $.ajax({
            url: '/firmstaff/on_off_multifactor',
            type: 'POST',
            headers: { 'CSRF-Token': csrfToken },
            data: {  status: newStatus, _csrf: csrfToken },
            beforeSend: function () {
              // Hide the kilstatus paragraph before the request
              $('.kilstatus').hide();
            },
            success: function (response) {
              console.log(response)

              if (response.success == true) {     

                 kilToast.success('MFA updated')   

                pmsgElement.innerHTML = response.msg;
                var msg = `${newStatus === 'On' ? 'Activated' : 'De-activated'} Multi-factor Auth Successfully !`;
                 window.location.href = '/firmstaff/profile'        



              } else {

                   kilToast.danger( response.msg)
                console.error('Error:', response.msg);
                $("#errorMessage").removeClass("d-none");
                $("#successMessage").addClass("d-none");
              }


            },
            error: function (error) {
           
              console.error('Error:', error);
                  kilToast.danger( error)
              $("#errorMessage").text('Ajax Error', error);
              $("#errorMessage").removeClass("d-none");
              $("#successMessage").addClass("d-none");
            }
            
          });
        }


      </script>


<script>
  // Keep your existing encrypt64(text) that uses CryptoJS + ENCRYPTION_SECRET_KEY

  async function on_off_multifactor(newStatus, username){
    // Ask for current password for step-up re-auth
    const { value: pwd } = await Swal.fire({
      title: `Confirm it's you`,
      html: `
        <p class="mb-2">Enter your <b>current password</b> to turn <b>${newStatus}</b> MFA for <b>${username}</b>.</p>
        <input id="mfaConfirmPwd" type="password" class="swal2-input" placeholder="Current password" autocomplete="current-password">
      `,
      input: null,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Confirm',
      preConfirm: () => {
        const v = document.getElementById('mfaConfirmPwd').value || '';
        if (!v.trim()) {
          Swal.showValidationMessage('Please enter your current password');
          return false;
        }
        return v;
      }
    });

    if (!pwd) return; // cancelled

    // Encrypt like your change password flow
    const encPwd = encrypt64(pwd.trim());

    $.ajax({
      url: '/firmstaff/on_off_multifactor',
      type: 'POST',
      headers: { 'CSRF-Token': csrfToken },
      data: {
        status: newStatus,
        confirm_password: encPwd,
        _csrf: csrfToken
      },
      beforeSend: function(){ /* optional loader */ },
      success: function(resp){
        if (resp?.success) {
          window.kweToast?.('success', 'MFA updated');
          // force full reload so the current tab reflects the new state
          window.location.href = '/firmstaff/profile'    
    
        } else {
          window.kweToast?.('danger', resp?.msg || 'Failed to update MFA');
        }
      },
      error: function(xhr){
        const msg = xhr?.responseJSON?.msg || 'Request failed';
        window.kweToast?.('danger', msg);
      }
    });
  }
</script>



