<!-- Header Start -->
<%- include('firmheader.ejs'); %>
<!-- Header End -->

<!-- Sidebar -->
<%- include('firmsidebar.ejs'); %>
<!-- Sidebar End -->

<div class="page-wrapper">
  <div class="content">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 pb-3 mb-3 border-bottom">
      <div class="d-flex align-items-center">
        <h5 class="fw-bold mb-0 me-2">Ticket Center</h5>
      </div>
    </div>

    <div class="table-responsive">
      <table id="ticketCenterTable" class="table table-striped table-bordered table-nowrap">
        <thead class="thead-light">
          <tr>
            <th>Ticket</th>
            <th>Subject</th>
            <th>Client</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Assigned</th>
            <th>Updated</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="assignTicketModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="assignTicketId" />
        <label class="form-label">Assign to staff</label>
        <select data-ignore-kilvish="Yes" class="form-select" id="assignStaffSelect"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="assignTicketBtn">Assign</button>
      </div>
    </div>
  </div>
</div>

<script>
  window.__FIRM_IS_ADMIN__ = <%= (staff?.role?.name === 'FirmAdmin') ? 'true' : 'false' %>;
</script>

<script>
window.addEventListener("load", () => {
  const tableBody = document.querySelector("#ticketCenterTable tbody");
  const assignModal = document.getElementById("assignTicketModal");
  const assignTicketIdInput = document.getElementById("assignTicketId");
  const assignStaffSelect = document.getElementById("assignStaffSelect");
  const assignBtn = document.getElementById("assignTicketBtn");
  const isAdmin = window.__FIRM_IS_ADMIN__ === true || window.__FIRM_IS_ADMIN__ === "true";

  function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || "";
  }

  function csrfHeaders(extra = {}) {
    const token = getCsrfToken();
    if (!token) return extra;
    return {
      ...extra,
      "X-CSRF-Token": token,
      "CSRF-Token": token,
      "X-XSRF-TOKEN": token,
    };
  }

  function formatTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    return d.toLocaleString();
  }

  function renderRows(rows) {
    if (!tableBody) return;
    tableBody.innerHTML = "";
    if (!rows.length) {
      const tr = document.createElement("tr");
      tr.dataset.status = String(row.status || "").toLowerCase();
      tr.innerHTML = "<td colspan=\"8\" class=\"text-center\">No tickets</td>";
      tableBody.appendChild(tr);
      return;
    }

    rows.forEach((row) => {
      const isClosed = String(row.status || "").toLowerCase() === "closed";
      const priorityValue = String(row.priority || "normal").toLowerCase();
      const tr = document.createElement("tr");
      const priorityCell = isAdmin
        ? `<select class="form-select form-select-sm priority-select" data-ticket="${row.ticket_id}" data-prev="${priorityValue}">
            <option value="low" ${priorityValue === "low" ? "selected" : ""}>Low</option>
            <option value="normal" ${priorityValue === "normal" ? "selected" : ""}>Normal</option>
            <option value="high" ${priorityValue === "high" ? "selected" : ""}>High</option>
            <option value="urgent" ${priorityValue === "urgent" ? "selected" : ""}>Urgent</option>
          </select>`
        : `<span>${priorityValue}</span>`;
      tr.innerHTML = `
        <td>${row.ticket_number || ""}</td>
        <td>${row.subject || ""}</td>
        <td>${row.client_label || ""}</td>
        <td>${row.status || ""}</td>
        <td>${priorityCell}</td>
        <td>${row.assigned_label || "Unassigned"}</td>
        <td>${formatTime(row.last_activity_iso)}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-btn" data-ticket="${row.ticket_id}">View</button>
          <button class="btn btn-sm btn-outline-danger ms-1 close-btn" data-ticket="${row.ticket_id}" ${isClosed ? "disabled" : ""}>Close</button>
          ${isAdmin ? `<button class="btn btn-sm btn-outline-secondary ms-1 assign-btn" data-ticket="${row.ticket_id}" data-assigned="${row.assigned_staff_id || ""}">Assign</button>` : ""}
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  async function loadTickets() {
    try {
      const client = window.axiosElaw || window.axios;
      if (!client) throw new Error("Axios not available");
      const res = await client.post("/firmstaff/tickets/json", {}, {
        headers: csrfHeaders()
      });
      const data = res?.data;
      if (!data?.success) {
        window.kilToast?.danger?.(data?.message || "Failed to load tickets");
        return;
      }
      renderRows(data.rows || []);
    } catch (e) {
      console.error("ticket list error:", e);
      window.kilToast?.danger?.("Failed to load tickets");
    }
  }

  async function loadStaffList(selectedId) {
    try {
      const res = await fetch("/firmstaff/tickets/staff");
      const data = await res.json();
      if (!data?.success) return;
      assignStaffSelect.innerHTML = "";
      (data.rows || []).forEach((staff) => {
        const opt = document.createElement("option");
        opt.value = staff.staff_id;
        opt.textContent = staff.name;
        assignStaffSelect.appendChild(opt);
      });
      if (selectedId) assignStaffSelect.value = String(selectedId);
    } catch (e) {
      console.error("staff list error:", e);
    }
  }

  async function openTicket(ticketId) {
    if (!ticketId) return;
    try {
      const client = window.axiosElaw || window.axios;
      if (!client) throw new Error("Axios not available");
      const res = await client.post("/firmstaff/tickets/open", { ticket_id: ticketId }, {
        headers: csrfHeaders()
      });
      const data = res?.data;
      if (!data?.success) {
        window.kilToast?.info?.(data?.message || "Unable to open ticket");
        return;
      }
      window.location.href = "/firmstaff/tickets/view";
    } catch (e) {
      console.error("open ticket error:", e);
      window.kilToast?.danger?.("Unable to open ticket");
    }
  }

  async function closeTicket(ticketId) {
    const client = window.axiosElaw || window.axios;
    if (!client) throw new Error("Axios not available");
    const res = await client.post("/firmstaff/tickets/close", { ticket_id: ticketId }, {
      headers: csrfHeaders()
    });
    return res?.data;
  }

  async function setPriority(ticketId, priority) {
    const client = window.axiosElaw || window.axios;
    if (!client) throw new Error("Axios not available");
    const res = await client.post("/firmstaff/tickets/priority", { ticket_id: ticketId, priority }, {
      headers: csrfHeaders()
    });
    return res?.data;
  }

  if (tableBody) {
    tableBody.addEventListener("click", (e) => {
      const viewBtn = e.target.closest(".view-btn");
      if (viewBtn) {
        const rowStatus = viewBtn.closest("tr")?.dataset.status;
        if (rowStatus === "closed") {
          window.kilToast?.info?.("Ticket already closed");
          return;
        }
        openTicket(viewBtn.getAttribute("data-ticket"));
        return;
      }
      const closeBtn = e.target.closest(".close-btn");
      if (closeBtn) {
        const ticketId = closeBtn.getAttribute("data-ticket");
        Swal.fire({
          title: "Close this ticket?",
          text: "You can re-open it later if needed.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, close",
          cancelButtonText: "Cancel",
        }).then(async (result) => {
          if (!result.isConfirmed) return;
          try {
            const data = await closeTicket(ticketId);
            if (!data?.success) {
              window.kilToast?.danger?.(data?.message || "Failed to close ticket");
              return;
            }
            window.kilToast?.success?.(data?.message || "Ticket closed");
            loadTickets();
          } catch (err) {
            console.error("close ticket error:", err);
            window.kilToast?.danger?.("Failed to close ticket");
          }
        });
        return;
      }
      if (!isAdmin) return;
      const btn = e.target.closest(".assign-btn");
      if (!btn) return;
      const rowStatus = btn.closest("tr")?.dataset.status;
      if (rowStatus === "closed") {
        window.kilToast?.info?.("Ticket already closed");
        return;
      }
      const ticketId = btn.getAttribute("data-ticket");
      const assignedId = btn.getAttribute("data-assigned");
      assignTicketIdInput.value = ticketId;
      loadStaffList(assignedId);
      const modal = new bootstrap.Modal(assignModal);
      modal.show();
    });
  }

  if (tableBody) {
    tableBody.addEventListener("change", async (e) => {
      const select = e.target.closest(".priority-select");
      if (!select) return;
      const ticketId = select.getAttribute("data-ticket");
      const priority = select.value;
      const prev = select.getAttribute("data-prev") || "";
      try {
        const data = await setPriority(ticketId, priority);
        if (!data?.success) {
          select.value = prev;
          window.kilToast?.danger?.(data?.message || "Failed to update priority");
          return;
        }
        select.setAttribute("data-prev", priority);
        window.kilToast?.success?.(data?.message || "Priority updated");
        loadTickets();
      } catch (err) {
        console.error("priority update error:", err);
        select.value = prev;
        window.kilToast?.danger?.("Failed to update priority");
      }
    });
  }

  if (assignBtn) {
    assignBtn.addEventListener("click", async () => {
      const ticketId = assignTicketIdInput.value;
      const staffId = assignStaffSelect.value;
      if (!ticketId || !staffId) return;
      try {
        const res = await fetch("/firmstaff/tickets/assign", {
          method: "POST",
          headers: csrfHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ ticket_id: ticketId, staff_id: staffId }),
          credentials: "same-origin"
        });
        const data = await res.json();
        if (!data?.success) {
          window.kilToast?.danger?.(data?.message || "Assign failed");
          return;
        }
        window.kilToast?.success?.(data?.message || "Assigned");
        loadTickets();
        const modal = bootstrap.Modal.getInstance(assignModal);
        modal.hide();
      } catch (e) {
        console.error("assign error:", e);
        window.kilToast?.danger?.("Assign failed");
      }
    });
  }

  loadTickets();
});
</script>

<!-- Footer Start -->
<%- include('firmfooter.ejs'); %>
<!-- Footer End -->
