<!-- Header Start -->
<%- include('clientheader.ejs'); %>
<!-- Header End -->
<% const isBiz = /business/i.test(clientdata.type || ''); %>

<section class="main-inner-banner">
    <!-- <span class="bg-icon"></span>
    <div class="inner-banner-shape"></div>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="inner-banner-content">
                    <h1 class="h1-title">My Profile</h1>
                    <p class="lead">Manage your personal details and account settings.</p>
                </div>
            </div>
        </div>
    </div> -->
</section>

<!-- Breadcrumb Start -->
<div class="breadcrumb-box">
	<ul>
		<li>
			<a href="/home" title="HOME">HOME</a>
		</li>
		<li>
			<a href="/profile" title="Profile">Profile</a>
		</li>
	</ul>
</div>
<!-- Breadcrumb End -->




<br/>

<section class="page-profile">
    <div class="container">
      

       

             <div class="card-body">

        <div class="row">
          <div class="col-lg-3">

            <div class="text-start">
              <button
                class="btn btn-md rounded fs-14 fw-medium text-white text-start mb-1 w-100 justify-content-start tab-link active"
                data-tab="profile-tab">
                <i class="ti ti-user-cog me-2 text-white"></i> Account Information
              </button>

              <button
                class="btn btn-md rounded fs-14 fw-medium text-white text-start mb-1 w-100 justify-content-start tab-link"
                data-tab="password-tab">
                <i class="ti ti-lock me-2 text-white"></i> Set / Change Password
              </button>

              <button
                class="btn btn-md rounded fs-14 fw-medium text-white text-start mb-1 w-100 justify-content-start tab-link"
                data-tab="twofa-tab">
                <i class="ti ti-shield-lock me-2 text-white"></i> Two-Step Verification
              </button>

              <!-- <button
                class="btn btn-md rounded fs-14 fw-medium text-white text-start mb-1 w-100 justify-content-start tab-link"
                data-tab="mfa-tab">
                <i class="ti ti-credit-card me-2 text-white"></i> Payment Modes
              </button> -->
            </div>

          </div><!-- end col -->

          <div class="col-lg-9">

                   

            <div class="border-1 border-start ps-4">

               <!-- Flash Msg Start -->
                  <%- include('partials/flash.ejs'); %>
                  <!-- Flash Msg  End -->

              <!-- Tab 1: Profile Settings -->
              <div id="profile-tab" class="tab-content-section">

                <form id="kilform" action="/profile" method="POST" class="p-4 border rounded shadow-lg bg-light">
                  <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
                  <input type="hidden" name="client_id" value="<%= clientdata.client_id || '0' %>">
                  <input type="hidden" name="type"
                    value="<%= clientdata.type || 'Individual' %>">

                  <div class="card-body pb-0">
                    <div class="contact-us-item-2">

                      <!-- Identification & Contact -->
                      <fieldset class="mb-4 border rounded p-3">
                        <legend class="fw-bold text-primary fs-18">Identification & Contact</legend>
                        <div class="row">

                          <div class="col-md-4">
                            <div class="form-group">
                              <label for="trnInput" class="form-label">TRN</label>
                              <div class="input-group">
                                <input
                                  data-kil-trn
                                  data-kilvish-char="mix_-_"
                                  readonly
                                  value="<%= clientdata.trn_number || '' %>"
                                  type="text"
                                  id="trnInput"
                                  name="trn_number"
                                  class="form-control"
                                  placeholder="Enter your TRN">
                              </div>
                              <div id="trnInputError" class="text-danger"></div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <div class="form-group">
                              <label for="emailInput" class="form-label">Email</label>
                              <div class="input-group">
                                <input
                                  type="email"
                                  readonly
                                  value="<%= clientdata.email || '' %>"
                                  id="emailInput"
                                  name="email"
                                  class="form-control"
                                  placeholder="Enter your email">
                              </div>
                              <div id="emailInputError" class="text-danger"></div>
                            </div>
                          </div>

                          <div class="col-md-4">
                            <label for="kilvishcontact" class="form-label mb-1 fw-medium">Mobile Number</label>
                            <div class="input-group kiltel-phone-wrap col-6">
                              <button type="button" class="kiltel-country-trigger"></button>
                              <input
                                type="tel"
                                class="form-control"
                                value="<%= clientdata.full_contact || '' %>"
                                data-kilvish-name="Mobile Number"
                                name="full_contact"
                                data-kilvish-tel
                                id="kilvishcontact"
                                data-kilvish-preferred="JM,IN"
                                data-kiltel-init="JM"
                                data-kiltel-validation="yes"
                                required>
                              <input type="hidden" id="country_code" name="country_code"
                                value="<%= clientdata.country_code || '' %>">
                              <input type="hidden" id="contact" name="contact"
                                value="<%= clientdata.contact || '' %>">
                            </div>
                            <div id="errorText1" class="text-danger"></div>
                            <div id="kiltel-error" class="text-danger" style="font-size:0.93em; margin-top:5px;"></div>
                          </div>

         

                        </div>
                      </fieldset>

                      <!-- Personal Information -->
                      <fieldset class="mb-4 border rounded p-3">
                        <legend class="fw-bold text-primary fs-18">Personal Information</legend>

                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <div class="form-group">
                              <label for="first_name" class="form-label">First Name</label>
                              <div class="input-group">
                                <input
                                  type="text"
                                  value="<%= clientdata.first_name || '' %>"
                                  id="first_name"
                                  name="first_name"
                                  class="form-control"
                                  placeholder="Enter your first name"
                                  required>
                              </div>
                            </div>
                          </div>

                          <div class="col-md-6 mb-3">
                            <div class="form-group">
                              <label for="last_name" class="form-label">Last Name</label>
                              <div class="input-group">
                                <input
                                  type="text"
                                  value="<%= clientdata.last_name || '' %>"
                                  id="last_name"
                                  name="last_name"
                                  class="form-control"
                                  placeholder="Enter your last name"
                                  required>
                              </div>
                            </div>
                          </div>


                          
                                      <!-- Client Photo -->
        <div class="col-md-6">
          <label class="form-label fw-medium mb-1">Client Photo (optional)</label>

          <% if (clientdata.profile_pic) { %>
            <div class="d-flex flex-column gap-2">

              <!-- Buttons: View / Replace / Remove -->
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <!-- View from S3 via secure proxy -->
                <a class="btn btn-outline-primary btn-sm"
                  href="/secure/file_stream?s3key=<%= encodeURIComponent(clientdata.profile_pic) %>"
                  target="_blank">
                  <i class="ti ti-external-link me-1"></i> View
                </a>

                <!-- Replace = upload new file -->
                <label class="btn btn-outline-secondary btn-sm mb-0">
                  <i class="ti ti-upload me-1"></i> Replace
                  <input
                    type="file"
                    name="profile_pic"
                    class="d-none"
                    accept=".jpg,.jpeg,.png,.jfif">
                </label>

                <!-- Remove existing photo -->
                <div class="form-check">
                  <input
                    class="form-check-input"
                    data-ignore-kilvish="Yes"
                    type="checkbox"
                    id="remove_profile_pic"
                    name="remove_profile_pic"
                    value="1">
                  <label class="form-check-label" for="remove_profile_pic">
                    Remove
                  </label>
                </div>
              </div>

              <!-- Small inline preview (also via secure route) -->
              <div>
                <img
                  src="/secure/file_stream?s3key=<%= encodeURIComponent(clientdata.profile_pic) %>"
                  alt="Client Photo"
                  class="rounded border"
                  style="width:80px;height:80px;object-fit:cover;">
              </div>
            </div>
          <% } else { %>
            <!-- No existing photo ‚Üí normal file input -->
            <input
              type="file"
              name="profile_pic"
              id="profile_pic"
              class="form-control"
              accept=".jpg,.jpeg,.png,.jfif">
          <% } %>

          <div class="form-text">
            Recommended square image, max 2MB. This will be stored on S3 and served via a secure URL.
          </div>
        </div>

       






            <!-- DOB -->
            <div class="col-md-6">
              <label class="form-label fw-medium" for="dob">Date of Birth</label>
              <input
                id="dob"
                name="dob"
                type="date"
                class="form-control"
                value="<%= clientdata.dob ? String(clientdata.dob).substring(0,10) : '' %>">
              <div class="form-text">Optional, used for age-based checks.</div>
            </div>








                        </div>

                        <div class="row">
                          <div class="col-md-12 mb-3">
                            <label for="address" class="form-label">Address</label>
                            <div class="input-group">
                              <input
                                data-ignore-kilvish="yes"
                                type="text"
                                id="address"
                                value="<%= clientdata.address || '' %>"
                                name="address"
                                class="form-control"
                                placeholder="Enter address"
                                required>
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <div class="form-group">
                              <label for="parish" class="form-label">Parish</label>
                              <select id="parish" name="parish" class="form-control" required>
                                <option value="">Select Parish</option>
                                <% (states || []).forEach(function(p) {
                                     const label = p.replace(/^Saint\s/, 'St. ');
                                %>
                                  <option value="<%= p %>" <%= (clientdata.parish===p) ? 'selected' : '' %>>
                                    <%= label %>
                                  </option>
                                <% }); %>
                              </select>
                            </div>
                          </div>

                          <div class="col-md-6 mb-3">
                            <div class="form-group">
                              <label for="postal_zone" class="form-label">Postal Zone</label>
                              <div class="input-group">
                                <input
                                  type="text"
                                  data-kilvish-char="mix"
                                  id="postal_zone"
                                  value="<%= clientdata.postal_zone || '' %>"
                                  name="postal_zone"
                                  class="form-control"
                                  placeholder="Enter postal code">
                              </div>
                            </div>
                          </div>
                        </div>
                      </fieldset>
                    </div>
                  </div>

                  <div class="d-flex align-items-center justify-content-end">
                    <button type="submit" class="btn btn-primary btn-md fs-13 fw-medium rounded">
                      Save Changes
                    </button>
                  </div>
                </form>

              </div>
              <!-- /Tab 1: Profile Settings -->

              <!-- ==================== Tab 2: Set / Change Password ==================== -->
              <div id="password-tab" class="tab-content-section d-none">
                <h5 class="fw-bold pb-3 mb-4 border-1 border-bottom">Set / Change Password</h5>

                <!-- Expose flags to JS -->
                <div
                  id="pw-meta"
                  data-has-password="<%= clientdata.password ? 'true' : 'false' %>"
                  data-email="<%= clientdata.email %>">
                </div>

                <form id="pwForm" novalidate>
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" id="pw_otp_id" name="otp_id">
                  <input type="hidden" id="timezonePw" name="timezone" data-ignore-kilvish="Yes">

                  <!-- If password exists ‚Üí ask Current Password too -->
                  <div id="curPassRow" class="mb-3" style="display:none;">
                    <label class="form-label fw-medium">Current Password</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light">
                        <i class="ti ti-key text-primary"></i>
                      </span>
                      <input
                        data-ignore-kilvish="Yes"
                        data-kileye-color="#001489"
                        type="password"
                        id="current_password"
                        class="form-control"
                        placeholder="Current password">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-medium">New Password</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light">
                        <i class="ti ti-lock text-primary"></i>
                      </span>
                      <input
                        type="password"
                        id="new_password"
                        data-kileye-color="#001489"
                        class="form-control"
                        placeholder="New password"
                        required>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-medium">Confirm New Password</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light">
                        <i class="ti ti-lock-check text-primary"></i>
                      </span>
                      <input
                        data-ignore-kilvish="Yes"
                        data-kileye-color="#001489"
                        type="password"
                        id="confirm_password"
                        class="form-control"
                        placeholder="Confirm new password"
                        required>
                    </div>
                  </div>

                  <!-- OTP block (appears after Send OTP) -->
                  <div id="pw-otp-wrap" class="mb-3" style="display:none;">
                    <label class="form-label fw-medium">Email OTP</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light">
                        <i class="ti ti-message-2 text-primary"></i>
                      </span>
                      <input
                        type="text"
                        id="pw_otp"
                        name="otp"
                        class="form-control"
                        placeholder="Enter OTP"
                        autocomplete="one-time-code">
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                      <small class="text-muted">OTP sent to your email.</small>
                      <button type="button" id="pwResendOtp" class="btn btn-link p-0">Resend OTP</button>
                    </div>
                    <div class="text-danger mt-1" id="pwOtpError"></div>
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" id="pwSave" class="btn btn-primary">
                      <i class="ti ti-device-floppy me-1"></i> Save Password
                    </button>
                  </div>

                  <div class="text-danger mt-2" id="pwError"></div>
                </form>

                <div class="small text-muted mt-3">
                  Tip: We‚Äôll verify the change by OTP. If you already have a password, we‚Äôll also confirm your current password.
                </div>
              </div>
              <!-- ==================== /Tab 2 ==================== -->

              <!-- ==================== Tab 3: Two-Step Verification ==================== -->
              <div id="twofa-tab" class="tab-content-section d-none">
                <h5 class="fw-bold pb-3 mb-4 border-1 border-bottom">Two-Step Verification</h5>

                <div class="card shadow-sm p-3 rounded">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <div class="fw-semibold">Require a second factor after password login</div>
                      <div class="text-muted small">
                        When ON, after password login we‚Äôll ask for an OTP before completing sign-in.
                      </div>
                    </div>
                    <div>
                      <div class="form-check form-switch">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="twofaSwitch"
                          <%= clientdata.two_step_verification === 'On' ? 'checked' : '' %> >
                        <label class="form-check-label" for="twofaSwitch">
                          <span id="twofaState">
                            <%= clientdata.two_step_verification === 'On' ? 'On' : 'Off' %>
                          </span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="small text-muted mt-3">
                  Note: OTP login (email code only) continues to work regardless of this setting.
                </div>
              </div>
              <!-- ==================== /Tab 3 ==================== -->

              <!-- Tab 4: Saved Cards -->
              <div id="mfa-tab" class="tab-content-section d-none">
                <h5 class="fw-bold pb-3 mb-4 border-1 border-bottom">Saved Cards</h5>

                <div class="card shadow-sm p-3 rounded">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0">Your tokenized cards</h6>
                    <small class="text-muted">Manage cards saved during checkout</small>
                  </div>

                  <div id="pm-list" class="row g-3">
                    <!-- cards will render here -->
                  </div>

                  <div id="pm-empty" class="text-center text-muted py-4 d-none">
                    <i class="bi bi-credit-card-2-front" style="font-size:1.6rem;"></i>
                    <div class="mt-2">No saved cards yet.</div>
                  </div>
                </div>
              </div>
              <!-- /Tab 4 -->

            </div>
          </div> <!-- end col -->
        </div>

      </div><!-- end card body -->






    </div>
</section><br><br>


<!-- Kiltel Phone Input -->
<input type="tel" id="hidden-iti-input" style="display:none;">
<!-- Kiltel Phone Input -->

<!-- Footer Start -->
<%- include('clientfooter.ejs'); %>
<!-- Footer End -->


<script>


  const fx = window.axiosElaw || window.axios || null;

     // const fx1 = (window.axiosElaw);

</script>


<script>
  document.querySelectorAll('.tab-link').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('text-primary', 'active'));
      document.querySelectorAll('.tab-content-section').forEach(tab => tab.classList.add('d-none'));
      btn.classList.add('text-primary', 'active');
      document.getElementById(btn.dataset.tab).classList.remove('d-none');

      // optional: lazy reload cards when Payment tab is opened
      if (btn.dataset.tab === 'mfa-tab' && window.loadPaymentMethods) {
        window.loadPaymentMethods();
      }
    });
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.cookie = 'sscl_msg' + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/';
  document.cookie = 'sscl_msg' + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
});
</script>

<!-- (Profile pic cropper code kept as-is) -->
<script>
  var loadFile = function (event) {
    const inputField = event.target;
    const errorMessageDiv = document.getElementById('errmsg1');
    const file1 = inputField.files[0];

    const validImageTypes = [
      'image/jpeg','image/png','image/gif','image/bmp',
      'image/tiff','image/webp','image/svg+xml'
    ];

    if (!validImageTypes.includes(file1.type)) {
      errorMessageDiv.textContent = 'Please select a valid image file (JPEG or PNG)!';
      errorMessageDiv.style.color = 'red';
      inputField.value = '';
    } else {
      errorMessageDiv.textContent = '';

      const file = inputField.files[0];
      if (!file) {
        console.error("No file selected.");
        return;
      }

      var reader = new FileReader();
      reader.onload = function (e) {
        let cropper;

        Swal.fire({
          title: 'Crop Your Image',
          html: '<div style="width:100%; text-align:center;"><img id="image-to-crop" style="max-width:100%;"></div>',
          didOpen: () => {
            const img = document.getElementById('image-to-crop');
            img.src = e.target.result;
            cropper = new Cropper(img, {
              aspectRatio: 1,
              viewMode: 1,
            });
          },
          showCancelButton: true,
          confirmButtonText: 'Crop & Upload',
          preConfirm: () => {
            return new Promise((resolve, reject) => {
              if (!cropper) {
                reject("Cropper instance is undefined");
              }
              const canvas = cropper.getCroppedCanvas();
              canvas.toBlob((blob) => {
                resolve(blob);
              });
            });
          },
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            const croppedImageBlob = result.value;

            const croppedFile = new File([croppedImageBlob], "cropped-image.png", { type: "image/png" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            inputField.files = dataTransfer.files;

            const image = document.getElementById("output");
            image.src = URL.createObjectURL(croppedFile);

            var formData = new FormData();
            formData.append("image", croppedFile);

            $.ajax({
              url: "/superadmin/update_admin_pic",
              type: "POST",
              headers: { 'CSRF-Token': csrfToken },
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                if (response.msg == 'success') {
                  $("#successMessage").removeClass("d-none");
                  $("#errorMessage").addClass("d-none");
                } else {
                  $("#errorMessage").removeClass("d-none");
                  $("#successMessage").addClass("d-none");
                }
              },
              error: function () {
                $("#errorMessage").removeClass("d-none");
                $("#successMessage").addClass("d-none");
              },
            });
          }
        }).catch((err) => {
          console.error(err);
        });
      };

      if (file) {
        reader.readAsDataURL(file);
      } else {
        console.error("File is not valid.");
      }
    }
  };
</script>

<script>
function on_off_multifactor(user_id, newStatus, username) {
  event.preventDefault();
  var action = (newStatus == 'Off') ? 'Deactivated' : 'activated';

  const userStatusElement = document.getElementById(`userStatus${user_id}`);
  const pmsgElement = document.getElementById(`msg${user_id}`);

  $.ajax({
    url: '/on_off_multifactor',
    type: 'POST',
    headers: { 'CSRF-Token': csrfToken },
    data: { id: user_id, status: newStatus, _csrf: csrfToken },
    beforeSend: function () { $('.kilstatus').hide(); },
    success: function (response) {
      if (response.success == true) {
        $('[data-user-id="' + user_id + '"]').attr('data-user-status', newStatus);

        var imgSrc = (newStatus === 'On') ? '../images/icons/active.png' : '../images/icons/inactive.png';
        $('[data-user-id="' + user_id + '"] .two_step_verification-image').attr('src', imgSrc);
        $('[data-user-id="' + user_id + '"] .two_step_verification-tooltip').attr('title', (newStatus === 'On') ? 'deactive' : 'active');

        var bgColor = (newStatus === 'On') ? 'rgba(163,209,121,0.5)' : 'rgba(227 99 99 / 50%)';
        var textColor = (newStatus === 'On') ? '#3c763d' : '#ffffff';

        $('[data-user-id="' + user_id + '"] .two_step_verification-overlay').css({
          'background-color': bgColor,
          'color': textColor + ' !important',
        }).fadeIn();

        pmsgElement.innerHTML = response.msg;
        var msg = `${newStatus === 'On' ? 'Activated' : 'De-activated'} Multi-factor Auth Successfully !`;
        document.cookie = `sscl_msg=${msg}`;

        setTimeout(function () {
          $('[data-user-id="' + user_id + '"] .two_step_verification-overlay').fadeOut();
          window.location.href = '/profile';
        }, 1500);
      } else {
        console.error('Error:', response.msg);
        $("#errorMessage").removeClass("d-none");
        $("#successMessage").addClass("d-none");
      }
    },
    error: function (error) {
      alert("ajax error");
      console.error('Error:', error);
      $("#errorMessage").text('Ajax Error', error);
      $("#errorMessage").removeClass("d-none");
      $("#successMessage").addClass("d-none");
    }
  });
}
</script>

<!-- SweetAlert2 (only if not already loaded globally) -->
<script>
  (function ensureSwal() {
    if (!window.Swal && !document.getElementById('swal2-cdn')) {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js';
      s.id = 'swal2-cdn';
      document.head.appendChild(s);
    }
  })();
</script>

<!-- Saved Cards (Payment Modes) -->
<script>
  (function () {
    const fx = (window.axiosElaw);
    const listWrap = document.getElementById('pm-list');
    const emptyEl = document.getElementById('pm-empty');

    const fmtExp = (m, y) => {
      if (!m || !y) return '‚Äî';
      const mm = String(m).padStart(2, '0');
      const yy = String(y).slice(-2);
      return `${mm}/${yy}`;
    };

    function cardTemplate(c) {
      const badge = c.is_default
        ? '<span class="badge bg-success ms-2">Default</span>'
        : '';
      const brandIcon = (c.brand || '').toLowerCase().includes('visa') ? 'bi bi-credit-card-2-front' :
        (c.brand || '').toLowerCase().includes('master') ? 'bi bi-credit-card' :
          'bi bi-credit-card';
      return `
        <div class="col-lg-6" data-pm-id="${c.pm_id}">
          <div class="border rounded p-3 h-100 d-flex">
            <div class="me-3 d-flex align-items-start">
              <i class="${brandIcon}" style="font-size:1.8rem;"></i>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center">
                <div class="fw-semibold">${c.brand || 'Card'} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${c.last4 || '‚Äî'}</div>
                ${badge}
              </div>
              <div class="small text-muted">Exp: ${fmtExp(c.exp_month, c.exp_year)}</div>
              <div class="small text-muted mt-1">
                ${(c.billing_name ? `${c.billing_name} ¬∑ ` : '')}
                ${(c.bill_to_email || '')}
                ${(c.bill_to_phone ? ` ¬∑ ${c.bill_to_phone}` : '')}
              </div>
            </div>
            <div class="ms-3">
              <button class="btn btn-outline-danger btn-sm pm-del-btn" data-pm-id="${c.pm_id}">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
    }

    async function loadPaymentMethods() {
      try {
        listWrap.innerHTML = '';
        emptyEl.classList.add('d-none');

   

        const { data: json } = await fx.get('/api/v1/payment_methods');
        if (!json?.success) throw new Error(json?.message || 'Load failed');

        const arr = Array.isArray(json.cards) ? json.cards : [];
        if (!arr.length) {
          emptyEl.classList.remove('d-none');
          return;
        }

        listWrap.innerHTML = arr.map(cardTemplate).join('');

        listWrap.querySelectorAll('.pm-del-btn').forEach(btn => {
          btn.addEventListener('click', onDeleteClick);
        });
      } catch (e) {
       // kilToast.danger(e?.message || 'Could not load saved cards');
        emptyEl.classList.remove('d-none');
      }
    }

    async function onDeleteClick(ev) {
      const btn = ev.currentTarget;
      const pm_id = btn.getAttribute('data-pm-id');

      if (!window.Swal) {
        kilToast.warning('Confirm dialog not ready. Try again.');
        return;
      }

      const ok = await Swal.fire({
        title: 'Delete this card?',
        text: 'You will not be able to use this saved card for future payments.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#d33'
      }).then(r => r.isConfirmed);

      if (!ok) return;

      btn.disabled = true;
      try {
        const { data: json } = await fx.post('/api/v1/payment_methods/delete', { pm_id: Number(pm_id) });
        if (!json?.success) throw new Error(json?.message || 'Delete failed');

        const tile = listWrap.querySelector(`[data-pm-id="${pm_id}"]`);
        if (tile) tile.remove();

        if (!listWrap.querySelector('[data-pm-id]')) {
          emptyEl.classList.remove('d-none');
        }

        kilToast.success('Card removed');
      } catch (e) {
        kilToast.danger(e?.message || 'Delete failed');
      } finally {
        btn.disabled = false;
      }
    }

    window.loadPaymentMethods = loadPaymentMethods;
    loadPaymentMethods();
  })();
</script>

<!-- ===== RSA PUBLIC KEY + helper (same style as login/signup) ===== -->
<script>
  const RSA_PUBLIC_KEY = `<%- (RSA_PUBLIC_KEY || '').replace(/\r?\n/g, '\\n') %>`;

  function pemToArrayBuffer(pem) {
    if (!pem) return null;
    const b64 = pem
      .replace(/-----BEGIN [^-]+-----/g, '')
      .replace(/-----END [^-]+-----/g, '')
      .replace(/\s+/g, '');
    const raw = atob(b64);
    const buf = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) buf[i] = raw.charCodeAt(i);
    return buf.buffer;
  }

  let rsaPubKeyPromise = null;

  async function getRsaPubKey() {
    if (!window.crypto || !crypto.subtle) {
      throw new Error('WebCrypto is not available in this browser.');
    }
    if (!rsaPubKeyPromise) {
      rsaPubKeyPromise = (async () => {
        const keyData = pemToArrayBuffer(RSA_PUBLIC_KEY);
        if (!keyData) throw new Error('Missing RSA public key');
        return await crypto.subtle.importKey(
          'spki',
          keyData,
          { name: 'RSA-OAEP', hash: 'SHA-256' },
          false,
          ['encrypt']
        );
      })().catch(err => {
        console.error('RSA public key import error:', err);
        rsaPubKeyPromise = null;
        throw err;
      });
    }
    return rsaPubKeyPromise;
  }

  // üîê Encrypt plain text ‚Üí base64 ciphertext using RSA-OAEP (SHA-256)
  async function rsaEncrypt(plain) {
    if (!plain) return '';
    try {
      const key = await getRsaPubKey();
      const data = new TextEncoder().encode(plain);
      const enc = await crypto.subtle.encrypt({ name: 'RSA-OAEP' }, key, data);
      const bytes = new Uint8Array(enc);
      let bin = '';
      for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
      return btoa(bin);
    } catch (e) {
      console.error('RSA-OAEP encrypt error:', e);
      return '';
    }
  }
</script>

<!-- ===== Password change + 2SV toggle (RSA-based) ===== -->
<script>
(function(){
  const toast = window.kilToast || {
    success: (m)=>alert(m),
    danger:  (m)=>alert(m),
    warning: (m)=>alert(m),
    info:    (m)=>alert(m)
  };

  const fx = window.axiosElaw || null;

  function getTz() {
    try { return Intl.DateTimeFormat().resolvedOptions().timeZone; }
    catch { return ''; }
  }

  function disable(el, yes){
    if (!el) return;
    el.disabled = !!yes;
    if (yes) el.setAttribute('aria-busy','true'); else el.removeAttribute('aria-busy');
  }

  async function postJSON(url, data){
    if (fx && fx.post) {
      const { data: json } = await fx.post(url, data, {
        headers:{ 'Accept':'application/json' },
        timeout: 20000
      });
      return json;
    }
    const res = await (window.kFetch || window.fetch)(url, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Accept':'application/json',
        'CSRF-Token': (window.getCsrf?.() || '')
      },
      body: JSON.stringify(data)
    });
    return await res.json();
  }

  // ===== dom =====
  const meta       = document.getElementById('pw-meta');
  const hasPw      = meta ? (meta.dataset.hasPassword === 'true') : false;
  const email      = meta ? (meta.dataset.email || '').trim() : '';

  const curRow     = document.getElementById('curPassRow');
  if (curRow) curRow.style.display = hasPw ? '' : 'none';

  const tzInp      = document.getElementById('timezonePw');
  if (tzInp) tzInp.value = getTz();

  const form       = document.getElementById('pwForm');
  const btnSave    = document.getElementById('pwSave');

  const otpWrap    = document.getElementById('pw-otp-wrap');
  const otpInp     = document.getElementById('pw_otp');
  const otpIdInp   = document.getElementById('pw_otp_id');
  const resendBtn  = document.getElementById('pwResendOtp');
  const errDiv     = document.getElementById('pwError');
  const otpErr     = document.getElementById('pwOtpError');

  let sendingOtp = false;
  let resendTimerId = null;

  function startResendCountdown(btn, seconds){
    if (!btn) return;
    let t = seconds;
    disable(btn, true);
    btn.textContent = `Resend OTP (${t}s)`;
    clearInterval(resendTimerId);
    resendTimerId = setInterval(()=>{
      t--;
      if (t <= 0){
        clearInterval(resendTimerId);
        btn.textContent = 'Resend OTP';
        disable(btn, false);
      } else {
        btn.textContent = `Resend OTP (${t}s)`;
      }
    }, 1000);
  }

  async function sendOtp(){
    if (sendingOtp) return;
    if (!email){
      toast.warning('No email on file.');
      return false;
    }

    sendingOtp = true;
    try{
      const encEmail = await rsaEncrypt(email);
      if (!encEmail) throw new Error('Encryption failed');

      const json = await postJSON('/send_password_otp', {
        type: 'Client',
        purpose: 'reset_password',
        email: encEmail
      });

      if (!json?.success){
        toast.danger(json?.message || 'Failed to send OTP');
        return false;
      }

      if (json.otp_id) otpIdInp.value = json.otp_id;

      otpWrap.style.display = '';
      otpInp?.focus();
      startResendCountdown(resendBtn, 30);

      toast.success(json.message || 'OTP sent');
      return true;
    } catch(e){
      toast.danger(e?.message || 'Failed to send OTP');
      return false;
    } finally {
      sendingOtp = false;
    }
  }

  // Resend link
  if (resendBtn) resendBtn.addEventListener('click', async ()=>{ await sendOtp(); });

  // Main submit
  if (form) form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errDiv.textContent = '';
    otpErr.textContent = '';

    const cur = (document.getElementById('current_password')?.value || '').trim();
    const npw = (document.getElementById('new_password')?.value || '').trim();
    const cpw = (document.getElementById('confirm_password')?.value || '').trim();
    const otp = (otpInp?.value || '').trim();
    const otp_id = (otpIdInp?.value || '').trim();
    const timezone = (tzInp?.value || '').trim();

    if (!npw || !cpw){
      toast.warning('Enter new password and confirm password');
      return;
    }
    if (npw !== cpw){
      toast.warning('New password and confirm password do not match');
      return;
    }
    if (hasPw && !cur){
      toast.warning('Enter your current password');
      return;
    }

    // If we don't yet have OTP or otp_id: send OTP first
    if (!otp_id || !otp){
      disable(btnSave, true);
      const ok = await sendOtp();
      disable(btnSave, false);
      if (ok){
        toast.info('We sent you a code. Enter it to finish.');
      }
      return;
    }

    // Encrypt payload and submit
    disable(btnSave, true);
    try{
      const payload = {
        email:            await rsaEncrypt(email),
        otp:              await rsaEncrypt(otp),
        otp_id,
        new_password:     await rsaEncrypt(npw),
        confirm_password: await rsaEncrypt(cpw),
        current_password: cur ? await rsaEncrypt(cur) : '',        
        timezone:         (timezone || '')
      };

      const json = await postJSON('/change_password', payload);
      if (!json?.success){
        const msg = json?.message || 'Password change failed';
        errDiv.textContent = msg;
        toast.danger(msg);
        return;
      }

      toast.success(json?.message || 'Password updated');

      form.reset();
      otpWrap.style.display = 'none';
      otpIdInp.value = '';
      if (!hasPw && curRow){
        curRow.style.display = '';
        if (meta) meta.dataset.hasPassword = 'true';
      }

      // usually logout after password change
      location.assign('/logout');

    } catch(e){
      const msg = e?.response?.data?.message || e?.message || 'Password change failed';
      errDiv.textContent = msg;
      toast.danger(msg);
    } finally {
      disable(btnSave, false);
    }
  });

  // ===== Two-Step toggle =====
  const twofaSwitch = document.getElementById('twofaSwitch');
  const twofaState  = document.getElementById('twofaState');
  if (twofaSwitch) twofaSwitch.addEventListener('change', async ()=>{
    const val = twofaSwitch.checked ? 'On' : 'Off';
    twofaSwitch.disabled = true;
    try{
      const json = await postJSON('/two_step_toggle', { status: val });
      if (!json?.success) throw new Error(json?.message || 'Update failed');
      if (twofaState) twofaState.textContent = val;
      toast.success(`Two-Step Verification ${val === 'On' ? 'enabled' : 'disabled'}`);
    } catch(e){
      twofaSwitch.checked = !twofaSwitch.checked;
      toast.danger(e?.message || 'Could not update Two-Step setting');
    } finally {
      twofaSwitch.disabled = false;
    }
  });

})();
</script>
