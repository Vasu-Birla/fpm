<!-- Header Start -->
<%- include('clientheader.ejs'); %>
<!-- Header End -->

<section class="main-inner-banner">
  <!-- banner intentionally kept minimal for client portal -->
</section>

<!-- Breadcrumb Start -->
<div class="breadcrumb-box">
  <ul>
    <li><a href="/home" title="HOME">HOME</a></li>
    <li><a href="/cases" title="Cases">Cases</a></li>
  </ul>
</div>
<!-- Breadcrumb End -->

<section class="page-cases py-5">
  <div class="container">

    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-4">
      <div>
        <h2 class="h2-title mb-1">My Cases</h2>
        <p class="text-muted mb-0">All your matters across firms. Filter, search and view details.</p>
      </div>
      <a href="/dashboard" class="btn btn-outline-secondary btn-sm">Back to Dashboard</a>
    </div>

    <% if (output && output.message) { %>
      <div class="alert alert-<%= output.type || 'info' %>">
        <%= output.message %>
      </div>
    <% } %>

    <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">

    <!-- Filters -->
    <div class="card shadow-sm mb-3">
      <div class="card-body d-flex flex-wrap align-items-end gap-3">

        <div>
          <label class="form-label mb-1" for="caseFirmFilter">Firm</label>
          <select id="caseFirmFilter" class="form-select" data-ignore-kilvish="yes">
            <option value="">All Firms</option>
            <% (firms || []).forEach(f => { %>
              <option value="<%= f.firm_id %>"><%= f.firm_name %></option>
            <% }) %>
          </select>
        </div>

        <div>
          <label class="form-label mb-1" for="caseStatusFilter">Status</label>
          <select id="caseStatusFilter" class="form-select" data-ignore-kilvish="yes">
            <option value="">All</option>
            <option value="Open">Open</option>
            <option value="OnHold">On Hold</option>
            <option value="Closed">Closed</option>
            <option value="Archived">Archived</option>
          </select>
        </div>

        <div>
          <label class="form-label mb-1" for="caseTypeFilter">Case Type</label>
          <select id="caseTypeFilter" class="form-select" data-ignore-kilvish="yes">
            <option value="">All</option>
            <option value="Civil">Civil</option>
            <option value="Criminal">Criminal</option>
            <option value="Family">Family</option>
            <option value="IP">IP</option>
            <option value="Corporate">Corporate</option>
            <option value="Immigration">Immigration</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="ms-auto">
          <label class="form-label mb-1" for="caseSearch">Search</label>
          <input id="caseSearch" type="text" class="form-control"
                 placeholder="Title, number, firm, jurisdiction..."
                 data-ignore-kilvish="yes">
        </div>

        <div>
          <button id="resetCaseFilters" class="btn btn-outline-secondary">
            Reset
          </button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table id="casesTable"
                 data-auto-dt="false"
                 class="table table-striped table-bordered table-nowrap w-100">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Case</th>
                <th>Firm</th>
                <th>Lead Lawyer</th>
                <th>Type</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Opened</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody><!-- DataTables will fill --></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const fx = window.axiosElaw || window.axios;
  if (!fx || !window.jQuery || !jQuery.fn.DataTable) return;

  const $tbl    = jQuery('#casesTable');
  const $firm   = jQuery('#caseFirmFilter');
  const $status = jQuery('#caseStatusFilter');
  const $type   = jQuery('#caseTypeFilter');
  const $search = jQuery('#caseSearch');
  const $reset  = jQuery('#resetCaseFilters');

  function fmtDate(d) {
    try {
      const dt = new Date(d);
      if (isNaN(dt)) return '-';
      const pad = n => (n < 10 ? '0' + n : '' + n);
      return (
        dt.getFullYear() + '-' +
        pad(dt.getMonth() + 1) + '-' +
        pad(dt.getDate())
      );
    } catch {
      return '-';
    }
  }

  function statusBadge(st) {
    if (st === 'Open') {
      return '<span class="badge badge-soft-success text-success border border-success">Open</span>';
    }
    if (st === 'OnHold') {
      return '<span class="badge badge-soft-warning text-warning border border-warning">On Hold</span>';
    }
    if (st === 'Closed') {
      return '<span class="badge badge-soft-secondary text-secondary border border-secondary">Closed</span>';
    }
    if (st === 'Archived') {
      return '<span class="badge badge-soft-dark text-dark border border-dark">Archived</span>';
    }
    return '<span class="badge badge-soft-light text-muted border">Unknown</span>';
  }

  function priorityBadge(p) {
    if (p === 'High') {
      return '<span class="badge badge-soft-danger text-danger border border-danger">High</span>';
    }
    if (p === 'Critical') {
      return '<span class="badge bg-danger text-white">Critical</span>';
    }
    if (p === 'Low') {
      return '<span class="badge badge-soft-secondary text-secondary border border-secondary">Low</span>';
    }
    return '<span class="badge badge-soft-primary text-primary border border-primary">Normal</span>';
  }

  function firmLabel(r){
    const name = r.firm_name || 'Firm';
    if (r.firm_logo) {
      const url = '/secure/file_stream?s3key=' + encodeURIComponent(r.firm_logo);
      return `
        <div class="d-flex align-items-center gap-2">
          <img src="${url}" alt="${name}" class="rounded-circle border"
               style="width:30px;height:30px;object-fit:cover;">
          <div class="fw-semibold">${name}</div>
        </div>
      `;
    }
    return `
      <div class="d-flex align-items-center gap-2">
        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border"
             style="width:30px;height:30px;font-weight:600;">
          ${name.slice(0,1).toUpperCase()}
        </div>
        <div class="fw-semibold">${name}</div>
      </div>
    `;
  }

  const dt = $tbl.DataTable({
    responsive: true,
    dom:
      "<'row mb-3'<'col-md-6 d-flex align-items-center'B><'col-md-6 d-flex justify-content-end'f>>" +
      "<'row'<'col-sm-12'tr>>" +
      "<'row mt-3'<'col-md-5'i><'col-md-7 d-flex justify-content-end'p>>",
    buttons: [
      { extend: 'excelHtml5', className: 'btn btn-primary me-2' },
      { extend: 'csvHtml5',   className: 'btn btn-primary me-2' }
    ],
    pageLength: 50,
    searching: false,
    serverSide: false,
    ajax: function(data, cb){
      const payload = {
        firm_id: $firm.val() || '',
        status:  $status.val() || '',
        type:    $type.val() || '',
        q:       $search.val() || ''
      };

      fx.post('/cases/json', payload)
        .then(({ data }) => {
          if (!data?.success) {
            window.kilToast?.danger?.(data?.message || 'Failed to load cases.');
            cb({ data: [] });
            return;
          }

          const rows = (data.rows || []).map((r, idx) => {
            const caseLabel = `
              <div class="fw-semibold">${r.title || ''}</div>
              <div class="text-muted small">${r.case_number || ''}</div>
            `;

            return {
              idx:      idx + 1,
              caseInfo: caseLabel,
              firm:     firmLabel(r),
              lead:     r.lead_lawyer || '-',
              type:     r.type || '-',
              priority: priorityBadge(r.priority || 'Normal'),
              status:   statusBadge(r.status || 'Open'),
              opened:   fmtDate(r.opened_at),
              actions:  `
                <button type="button"
                        class="btn btn-sm btn-outline-primary case-view"
                        data-id="${r.case_id}">
                  View Details
                </button>
              `
            };
          });

          cb({ data: rows });
        })
        .catch(err => {
          console.error('cases_json ajax error:', err);
          window.kilToast?.danger?.(err?.response?.data?.message || 'Failed to load cases.');
          cb({ data: [] });
        });
    },
    columns: [
      { data: 'idx' },
      { data: 'caseInfo' },
      { data: 'firm' },
      { data: 'lead' },
      { data: 'type' },
      { data: 'priority' },
      { data: 'status' },
      { data: 'opened' },
      { data: 'actions', orderable: false, searchable: false }
    ]
  });

  const $wrapper = $tbl.closest('.dataTables_wrapper');
  jQuery('.dataTables_filter', $wrapper).hide();

  function reloadWithDelay(){
    clearTimeout(window.__client_case_timer);
    window.__client_case_timer = setTimeout(() => dt.ajax.reload(), 250);
  }

  $firm.on('change', reloadWithDelay);
  $status.on('change', reloadWithDelay);
  $type.on('change', reloadWithDelay);
  $search.on('input', reloadWithDelay);

  $reset.on('click', function(e){
    e.preventDefault();
    $firm.val('');
    $status.val('');
    $type.val('');
    $search.val('');
    dt.ajax.reload();
  });

  $tbl.on('click', '.case-view', function(){
    const id = this.dataset.id;
    if (!id) return;
    document.cookie = `elaw_caseId=${id}; path=/;`;
    window.location.href = '/cases/view';
  });
});
</script>

<!-- Footer Start -->
<%- include('clientfooter.ejs'); %>
<!-- Footer End -->


