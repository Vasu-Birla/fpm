<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>E-Sign | <%= documentTitle %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    #pad { border: 1px solid #ddd; width: 100%; height: 300px; }
    .sig-img { max-width: 100%; border:1px solid #ccc; border-radius:8px; }
  </style>
  <script>
    window.__CSRF = "<%= csrfToken || '' %>";
  </script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="mb-3">Sign Document</h5>
            <p class="mb-1"><strong>Document:</strong> <%= documentTitle %></p>
            <% if (documentLink) { %>
              <p><a href="<%= documentLink %>" target="_blank">View Document</a></p>
            <% } %>
            <% if (alreadySigned) { %>
              <div class="alert alert-info">This document is already signed. Modifying the signature is not allowed.</div>
              <% if (signatureData) { %>
                <div class="mt-2">
                  <img src="<%= signatureData %>" alt="Signature" class="sig-img" oncontextmenu="return false;">
                </div>
              <% } %>
            <% } else { %>
              <canvas id="pad"></canvas>
              <div class="mt-3 d-flex gap-2">
                <button id="clearBtn" class="btn btn-secondary">Reset</button>
                <button id="saveBtn" class="btn btn-primary">Save & Send</button>
              </div>
              <div id="msg" class="mt-3 text-danger d-none"></div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    if (<%= alreadySigned ? 'true' : 'false' %>) {
      // disable right click globally
      document.addEventListener('contextmenu', e => e.preventDefault());
    }
    const canvas = document.getElementById('pad');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      function resize() {
        canvas.width = canvas.clientWidth;
        canvas.height = 300;
      }
      resize();
      let drawing = false;
      canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
      canvas.addEventListener('mousemove', e => { if (!drawing) return; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); });
      canvas.addEventListener('mouseup', () => drawing = false);
      canvas.addEventListener('mouseout', () => drawing = false);
      document.getElementById('clearBtn').onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); };
      document.getElementById('saveBtn').onclick = async () => {
        const data = canvas.toDataURL();
        if (!data) return;
        try {
          const resp = await fetch(window.location.pathname + '/sign', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(window.__CSRF ? { 'CSRF-Token': window.__CSRF } : {})
            },
            body: JSON.stringify({ signature_data: data, _csrf: window.__CSRF || undefined })
          });
          const out = await resp.json();
          if (out.success) {
            Swal.fire({
              title: 'Signed!',
              text: 'Signature captured successfully.',
              icon: 'success',
              timer: 2000,
              showConfirmButton: false,
              willClose: () => { window.close(); }
            });
          } else {
            Swal.fire({ title: 'Error', text: out.message || 'Failed to save signature.', icon: 'error' });
          }
        } catch (err) {
          Swal.fire({ title: 'Error', text: 'Error submitting signature.', icon: 'error' });
        }
      };
    }
  </script>
</body>
</html>
