<!-- Header Start -->
<%- include('superheader.ejs'); %>
<!-- Header End -->

<!-- Sidebar -->
<%- include('supersidebar.ejs'); %>



<style>
  .pa-suggest{border:1px solid #e7eaf0;border-radius:10px;background:#fff;box-shadow:0 8px 24px rgba(16,24,40,.08);max-height:30vh;overflow:auto}
  .pa-suggest-item{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .pa-suggest-item:hover{background:#f8fafc}
  .pa-suggest-item .meta{font-size:12px;color:#64748b}
  .pa-card{border:1px solid #e7eaf0;border-radius:12px;padding:12px 12px;background:#fff;box-shadow:0 1px 2px rgba(16,24,40,.04);margin-bottom:10px}
  .pa-card-head{display:flex;align-items:center;gap:8px}
  .pa-card-title{font-weight:600;color:#0f172a}
  .pa-chip-close{margin-left:auto;border:none;background:transparent;color:#ef4444;border-radius:8px;padding:4px 6px;cursor:pointer}
  .pa-chip-close:hover{background:#fee2e2}
  .pa-children{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
  .pa-child-chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #dbeafe;background:#eff6ff;color:#1d4ed8}
  .otp-wrap{display:none}
  .kil-lock-scroll{overflow:hidden}
</style>

<style>
  /* --- Practice Area modal list (same as your old one) --- */
  .pa-browse-modal{ text-align:left; }
  .pa-browse-modal .pa-browse-item{
    border:1px solid #e7eaf0; border-radius:10px; background:#fff;
    box-shadow:0 1px 2px rgba(16,24,40,.04);
    padding:10px; margin-bottom:8px;
    display:flex; justify-content:space-between; align-items:center; gap:12px;
  }
  .pa-browse-modal .label{ font-weight:600; }
  .pa-browse-modal .pa-browse-actions{ display:flex; align-items:center; }
  .pa-browse-modal .pa-browse-actions .btn{ min-width:88px; }

  /* keep it tidy on small screens */
  @media (max-width: 576px){
    .pa-browse-modal .pa-browse-item{ flex-wrap:wrap; }
    .pa-browse-modal .pa-browse-actions{ width:100%; justify-content:flex-end; }
  }
</style>


<div class="page-wrapper">
  <div class="content">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="mb-4">
          <h6 class="fw-bold mb-0 d-flex align-items-center">
            <a href="/superadmin/view_lawfirms" class="text-dark"><i class="ti ti-chevron-left me-1"></i>Law Firm</a>
          </h6>
        </div>

        <form id="kilform" method="POST" enctype="multipart/form-data" autocomplete="off">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="otp_id" id="otp_id">

          <div class="card">
            <div class="card-body pb-0">
              <div class="form">
                <h6 class="fw-bold mb-3">Law Firm Information</h6>

                <div class="row">
                  <div class="col-lg-12">
                    <div class="mb-3 d-flex align-items-center">
                      <label for="firm_logo" class="form-label mb-0">Firm Logo</label>
                      <div class="drag-upload-btn avatar avatar-xxl rounded-circle bg-light text-muted position-relative overflow-hidden z-1 mb-2 ms-4 p-0">
                        <i class="ti ti-user-plus fs-16"></i>
                        <input type="file" id="firm_logo" name="firm_logo" class="form-control image-sign" accept=".jpg,.jpeg,.png,.jfif">
                        <div class="position-absolute bottom-0 end-0 star-0 w-100 h-25 bg-dark d-flex align-items-center justify-content-center z-n1">
                          <a href="javascript:void(0);" class="text-white d-flex align-items-center justify-content-center">
                            <i class="ti ti-photo fs-14"></i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="firm_name" class="form-label mb-1 fw-medium">Firm Name <span class="text-danger">*</span></label>
                      <input type="text" id="firm_name" name="firm_name" class="form-control" placeholder="ABC Legal Associates" required>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="registration_number" class="form-label mb-1 fw-medium">Registration Number <span class="text-danger">*</span></label>
                      <input type="text" id="registration_number" data-kilvish-char="mix_-_" name="registration_number" class="form-control" placeholder="LAW2025-9876" required>
                    </div>
                  </div>

                  <!-- Firm Admin login identity -->
                  <div class="col-md-6">
                    <label for="emailInput" class="form-label mb-1 fw-medium">Firm Admin Email <span class="text-danger">*</span></label>
                    <input id="emailInput" type="email" name="email" class="form-control" placeholder="admin@firm.com" required>
                    <div id="emailInputError" class="text-danger small mt-1"></div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label mb-1 fw-medium">Firm Admin Phone <span class="text-danger">*</span></label>
                    <div class="input-group kiltel-phone-wrap col-6">
                      <button type="button" class="kiltel-country-trigger"></button>
                      <input data-ignore-kilvish="Yes" type="tel" class="form-control" name="full_contact" data-kilvish-tel id="kilvishcontact" data-kilvish-preferred="JM,IN" data-kiltel-init="JM" data-kiltel-validation="yes" required>
                      <input type="hidden" id="country_code" name="country_code">
                      <input type="hidden" id="contact" name="contact">
                    </div>
                    <div id="errorText1" class="text-danger small mt-1"></div>
                    <div id="kiltel-error" class="text-danger small"></div>
                  </div>

                  <!-- Password (optional but recommended) -->
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Create Password <small class="text-muted">(optional)</small></label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ti ti-key"></i></span>
                      <input type="password" id="password" class="form-control kilpass" placeholder="Set a password (optional)">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-medium">Confirm Password</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="ti ti-key"></i></span>
                      <input type="password" id="confirm_password" class="form-control kilpass" placeholder="Confirm password">
                    </div>
                  </div>



    
                </div>

                <h6 class="fw-bold mb-3 border-top pt-3">Service Locations</h6>
                <input type="hidden" id="locations_json" name="locations_json">
                <div id="locationsWrap" class="mb-3"></div>
                <div>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="addLocationBtn">
                    <i class="ti ti-plus me-1"></i>Add Location
                  </button>
                </div>

                <h6 class="fw-bold mb-3 border-top pt-3">Practice Areas</h6>
                <input type="hidden" id="practice_area_ids" name="practice_area_ids" value="[]">
                <div class="pa-picker card border-0 shadow-sm mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <div class="flex-grow-1">
                        <div class="input-group input-group-sm pa-search-group">
                          <span class="input-group-text bg-white"><i class="ti ti-search"></i></span>
                          <input type="text" id="paSearchInput" class="form-control" placeholder="Search practice areas (parents only)...">
                        </div>
                      </div>
                      <button type="button" id="paOpenList" class="btn btn-outline-primary btn-sm">
                        <i class="ti ti-list-search me-1"></i>Browse All
                      </button>
                    </div>
                    <div id="paSuggest" class="pa-suggest mt-2 d-none"></div>
                    <div id="paSelectedWrap" class="mt-3"></div>
                  </div>
                </div>

                <h6 class="fw-bold mb-3 border-top pt-3">Other Information</h6>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="description" class="form-label mb-1 fw-medium">Firm Description</label>
                      <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter about..."></textarea>
                    </div>
                  </div>

                  <div class="col-lg-6">
                    <div class="mb-3">
                      <label for="firm_certificate" class="form-label mb-1">Upload Firm Certificate/Document</label>
                      <div class="mb-3 d-flex align-items-center">
                        <div class="drag-upload-btn avatar avatar-xxl bg-light text-muted position-relative overflow-hidden z-1 mb-2 ms-0 p-0">
                          <i class="ti ti-user-plus fs-16"></i>
                          <input type="file" id="firm_certificate" name="firm_certificate" class="form-control image-sign" accept=".jpg,.jpeg,.png,.jfif,.pdf">
                          <div class="position-absolute bottom-0 end-0 star-0 w-100 h-25 bg-dark d-flex align-items-center justify-content-center z-n1">
                            <a href="javascript:void(0);" class="text-white d-flex align-items-center justify-content-center">
                              <i class="ti ti-photo fs-14"></i>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div> 
                </div>

              </div>
            </div>
          </div>


          
                           <!-- OTP block (appears after user clicks "Send OTP" below email field) -->
              <div id="signupOtpWrap" class="mt-3" style="display:none;">
                <label for="signupOtpInput" class="form-label fw-medium">Email OTP</label>
                <div class="input-group">
                  <span class="input-group-text bg-light"><i class="ti ti-lock text-primary"></i></span>
                  <input type="text" id="signupOtpInput" name="otp" class="form-control" placeholder="Enter OTP" autocomplete="one-time-code">
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <small class="text-muted">We sent an OTP to your email.</small>
                  <button type="button" id="signupResendOtp" class="btn btn-link p-0">Resend OTP</button>
                </div>
                <div class="text-danger mt-1" id="signupOtpError"></div>
              </div>


          <div class="d-flex align-items-center justify-content-end mt-3 gap-2">
            <button type="submit" class="btn btn-primary btn-md fs-13 fw-medium rounded" id="submitBtn">
              Save Law Firm
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<input type="tel" id="hidden-iti-input" style="display:none;">

<!-- Footer Start -->
<%- include('superfooter.ejs'); %>
<!-- Footer End -->

<script>
  // ====== Globals we rely on: csrfToken, axiosElaw, kilToast, CryptoJS, kFetch, Swal ======
  const states = <%- JSON.stringify(states || []) %>;
  const ENCRYPTION_SECRET_KEY = "<%= process.env.ENCRYPTION_SECRET_KEY %>";
  function mustCrypto(){ if(!window.CryptoJS||!ENCRYPTION_SECRET_KEY){ kilToast?.danger?.('Crypto not ready. Refresh.'); throw new Error('Crypto not ready'); } }
  function encrypt(v){ mustCrypto(); return CryptoJS.AES.encrypt(String(v??''), ENCRYPTION_SECRET_KEY).toString(); }
   const fx = (window.axiosElaw) || window.axios || null;

  // ====== Uniqueness checks ======
  (function(){
    const emailInput = document.getElementById('emailInput');
    const emailErr = document.getElementById('emailInputError');
    emailInput?.addEventListener('change', async ()=>{
      const email = (emailInput.value||'').trim();
      if(!email) return;
      try{
        const {data} = await fx.post('/superadmin/check_firm_email', { email }, { headers: {'CSRF-Token': csrfToken }});
        if(data?.exists){
          emailErr.textContent = `Email (${email}) already exists. Use a different email.`;
          kilToast?.danger?.('Email already exists');
          emailInput.value='';
        } else {
          emailErr.textContent = '';
        }
      }catch(e){
        emailErr.textContent = 'Error validating email.';
      }
    });

    const phone = document.getElementById('kilvishcontact');
    phone?.addEventListener('change', async ()=>{
      const phoneNumber = (phone.value||'').trim();
      const countryCode = document.getElementById('country_code')?.value || '';
      const err1 = document.getElementById('errorText1');
      if(!phoneNumber) return;
      try{
        const {data} = await fx.post('/superadmin/check_firm_phonenumber', { phoneNumber, countryCode }, { headers: {'CSRF-Token': csrfToken }});
        if(data?.exists){
          err1.textContent = `Phone (${phoneNumber}) already exists. Use a different phone.`;
          kilToast?.danger?.('Phone already exists');
          phone.value='';
        } else {
          err1.textContent='';
        }
      }catch(e){
        err1.textContent='Error validating phone.';
      }
    });
  })();

  // ====== Locations widget ======
  (function(){
    const wrap = document.getElementById('locationsWrap');
    const addBtn = document.getElementById('addLocationBtn');
    const hidden = document.getElementById('locations_json');

    let rows = [{ parish:'', address:'', is_primary:true, _deleted:false }];

    function parishOptions(selected){
      return ['<option value="">Select Parish</option>']
        .concat(states.map(p=>{
          const label = p.replace(/^Saint\s/, 'St. ');
          return `<option value="${p}" ${p===selected?'selected':''}>${label}</option>`;
        })).join('');
    }
    function serialize(){
      const payload = rows.filter(r=>!r._deleted).map(r=>({ parish:r.parish.trim(), address:r.address.trim(), is_primary:!!r.is_primary }));
      hidden.value = JSON.stringify(payload);
    }
    function render(){
      wrap.innerHTML='';
      rows.forEach((r,idx)=>{
        if(r._deleted) return;
        const el = document.createElement('div');
        el.className='card mb-2';
        el.innerHTML=`
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Parish<span class="text-danger">*</span></label>
                <select class="form-select parish-inp" data-idx="${idx}">${parishOptions(r.parish)}</select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Address<span class="text-danger">*</span></label>
                <input data-ignore-kilvish="Yes" type="text" class="form-control address-inp" data-idx="${idx}" placeholder="Full address" value="${(r.address||'').replace(/"/g,'&quot;')}">
              </div>
              <div class="col-md-2 d-flex align-items-center gap-2">
                <div class="form-check">
                  <input class="form-check-input primary-radio" type="radio" name="primaryLoc" data-idx="${idx}" ${r.is_primary?'checked':''}>
                  <label class="form-check-label">Primary</label>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm remove-loc" data-idx="${idx}">
                  <i class="ti ti-trash"></i>
                </button>
              </div>
            </div>
          </div>`;
        wrap.appendChild(el);
      });
      serialize();
    }
    wrap.addEventListener('change', (e)=>{
      const idx = +e.target.dataset.idx;
      if(e.target.classList.contains('parish-inp')){ rows[idx].parish = e.target.value; serialize(); }
      if(e.target.classList.contains('address-inp')){ rows[idx].address = e.target.value; serialize(); }
      if(e.target.classList.contains('primary-radio')){ rows.forEach((r,i)=>r.is_primary=(i===idx)); render(); }
    });
    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('.remove-loc'); if(!btn) return;
      const idx = +btn.dataset.idx;
      rows.splice(idx,1);
      if(!rows.length) rows.push({ parish:'', address:'', is_primary:true, _deleted:false });
      if(!rows.some(r=>r.is_primary)) rows[0].is_primary=true;
      render();
    });
    addBtn?.addEventListener('click', ()=>{
      rows.push({ parish:'', address:'', is_primary: rows.every(r=>!r.is_primary), _deleted:false });
      render();
    });
    render();
    document.getElementById('kilform')?.addEventListener('submit', serialize);
  })();

  // ====== Practice Areas (parents only) ======
  (function(){
    const fxLocal = (window.axiosElaw) || window.axios || null;
    const hidden = document.getElementById('practice_area_ids');
    const searchInp = document.getElementById('paSearchInput');
    const suggestBox = document.getElementById('paSuggest');
    const selectedWrap = document.getElementById('paSelectedWrap');
    const browseBtn = document.getElementById('paOpenList');
    let parents=[], selectedIds=[];

    function escapeHtml(s=''){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
    function setHidden(){ hidden.value = JSON.stringify(selectedIds); }
    function renderSelected(){
      setHidden();
      selectedWrap.innerHTML = selectedIds.map(id=>{
        const p = parents.find(x=>x.id===id); if(!p) return '';
        const childChips = (p.children||[]).slice(0,12).map(c=>`<span class="pa-child-chip">${escapeHtml(c.name)}</span>`).join('');
        const more = (p.children?.length>12)? `<span class="pa-child-chip">+${p.children.length-12}</span>`:'';
        return `<div class="pa-card" data-id="${p.id}">
          <div class="pa-card-head">
            <div class="pa-card-title">${escapeHtml(p.name)}</div>
            <button type="button" class="pa-chip-close" data-remove="${p.id}" title="Remove"><i class="ti ti-x"></i></button>
          </div>
          ${p.children?.length?`<div class="pa-children">${childChips}${more}</div>`:''}
        </div>`;
      }).join('') || `<div class="text-muted">No practice areas selected.</div>`;
    }
    function showSuggest(items){
      if(!items.length){ suggestBox.classList.add('d-none'); suggestBox.innerHTML=''; return;}
      suggestBox.innerHTML = items.map(p=>`
        <div class="pa-suggest-item" data-id="${p.id}">
          <div>${escapeHtml(p.name)}</div>
          <div class="meta">${p.children.length?`${p.children.length} sub-area${p.children.length>1?'s':''}`:'No sub-areas'}</div>
        </div>`).join('');
      suggestBox.classList.remove('d-none');
    }
    function filterSuggest(q){
      q=(q||'').trim().toLowerCase();
      if(!q){showSuggest([]);return;}
      const list = parents.filter(p=>p.name.toLowerCase().includes(q) || p.slug?.toLowerCase().includes(q))
                          .filter(p=>!selectedIds.includes(p.id)).slice(0,15);
      showSuggest(list);
    }
    searchInp.addEventListener('input',()=>filterSuggest(searchInp.value));
    document.addEventListener('click',(e)=>{
      const item = e.target.closest('.pa-suggest-item');
      if(item){
        const id = +item.dataset.id;
        if(!selectedIds.includes(id)) selectedIds.push(id);
        renderSelected(); suggestBox.classList.add('d-none'); searchInp.value='';
        return;
      }
      if(!e.target.closest('.pa-suggest') && e.target!==searchInp){ suggestBox.classList.add('d-none'); }
    });
    selectedWrap.addEventListener('click',(e)=>{
      const btn = e.target.closest('[data-remove]'); if(!btn) return;
      const id = +btn.dataset.remove;
      selectedIds = selectedIds.filter(x=>x!==id);
      renderSelected();
    });



    browseBtn.addEventListener('click', async () => {
  // render exactly like the old structure
  const html = parents.map(p => `
    <div class="pa-browse-item">
      <div class="label">${escapeHtml(p.name)}</div>
      <div class="pa-browse-actions">
        ${selectedIds.includes(p.id)
          ? `<button type="button" class="btn btn-outline-danger btn-sm" data-parem="${p.id}" data-action="remove">Remove</button>`
          : `<button type="button" class="btn btn-outline-primary btn-sm" data-parem="${p.id}" data-action="add">Add</button>`
        }
      </div>
    </div>
  `).join('');

  await Swal.fire({
    title: 'Browse Practice Areas (Parents)',
    html: `<div class="pa-browse-modal">${html}</div>`,
    width: 700,
    showCancelButton: true,
    confirmButtonText: 'Done',
    didOpen: () => {
      const modal = Swal.getHtmlContainer();
      modal.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const id = +btn.dataset.parem;
        const action = btn.dataset.action;

        if (action === 'add' && !selectedIds.includes(id)) {
          selectedIds.push(id);
          btn.outerHTML = `<button type="button" class="btn btn-outline-danger btn-sm" data-parem="${id}" data-action="remove">Remove</button>`;
        } else if (action === 'remove') {
          selectedIds = selectedIds.filter(x => x !== id);
          btn.outerHTML = `<button type="button" class="btn btn-outline-primary btn-sm" data-parem="${id}" data-action="add">Add</button>`;
        }
      });
    }
  });

  renderSelected();
});



    (async function init(){
      try{
        const {data} = await fxLocal.get('/superadmin/practice_areas_json');
        if(!data?.success) throw new Error(data?.message||'Failed to load areas');
        const flat = data.tree||[];
        const parentsOnly=[];
        (function dfs(list){
          for(const n of list){
            if(!n.parent_id){
              parentsOnly.push({ id:+n.practice_area_id, name:n.name, slug:n.slug, children:(n.children||[]).map(c=>({id:+c.practice_area_id,name:c.name})) });
            }
            if(n.children?.length) dfs(n.children);
          }
        })(flat);
        parentsOnly.sort((a,b)=>a.name.localeCompare(b.name));
        parents = parentsOnly;
        renderSelected();
      }catch(e){ kilToast?.danger?.(e?.message||'Failed to load practice areas'); }
    })();
  })();





</script>

<script>
/* ==========================
   OTP flow (KWE style) + AES encryption
========================== */
(function(){
  const ENCRYPTION_SECRET_KEY = "<%= process.env.ENCRYPTION_SECRET_KEY %>";
  function mustCrypto(){
    if(!window.CryptoJS || !ENCRYPTION_SECRET_KEY){
      (window.kilToast?.danger?.('Crypto not ready. Please refresh.') || alert('Crypto not ready. Please refresh.'));
      throw new Error('Crypto not ready');
    }
  }
  function encrypt(v){
    mustCrypto();
    return CryptoJS.AES.encrypt(String(v ?? ''), ENCRYPTION_SECRET_KEY).toString();
  }

  // --- DOM handles (use YOUR signup ids) ---
  const form            = document.getElementById('kilform');
  const submitBtn       = document.getElementById('submitBtn');
  const emailInput      = document.getElementById('emailInput');

  const otpWrap         = document.getElementById('signupOtpWrap');
  const otpInput        = document.getElementById('signupOtpInput');
  const resendBtn       = document.getElementById('signupResendOtp');
  const otpErr          = document.getElementById('signupOtpError');
  const otpIdHidden     = document.getElementById('otp_id');

  // KilTel hidden fields
  const countryCodeEl   = document.getElementById('country_code');
  const contactEl       = document.getElementById('contact');

  // Optional password fields
  const pass1           = document.getElementById('password');
  const pass2           = document.getElementById('confirm_password');

  // Persist stage on form dataset (survives minor reflows)
  const isAwaitingOtp = () => form?.dataset.awaitingOtp === '1';
  const setAwaitingOtp = (v) => { if(form) form.dataset.awaitingOtp = v ? '1' : '0'; };

  let resendTimer = null;
  function disable(el, yes){ if(!el) return; el.disabled = !!yes; el.setAttribute('aria-busy', yes?'true':'false'); }
  function countdown(btn, seconds){
    if(!btn) return;
    let t = seconds;
    clearInterval(resendTimer);
    disable(btn, true);
    btn.textContent = `Resend OTP (${t}s)`;
    resendTimer = setInterval(()=>{
      t--;
      if(t<=0){
        clearInterval(resendTimer);
        btn.textContent = 'Resend OTP';
        disable(btn, false);
      }else{
        btn.textContent = `Resend OTP (${t}s)`;
      }
    }, 1000);
  }

  async function sendOtp(){
    const email = (emailInput?.value || '').trim();
    if(!email){
      emailInput?.focus();
      window.kilToast?.warning?.('Please enter your email first.');
      return false;
    }

    // Build encrypted OTP payload
const payload = {
  type: 'Customer',
  purpose: 'register',
  email: encrypt(email),
  country_code: null,
  contact: null,
};

    try {
  const fx = (window.axiosElaw) || window.axios; // your CSRF-wired axios instance
  const { data: json } = await fx.post(
    '/superadmin/send_register_otp',
    payload,                                // <-- goes here, not in "body"
    { headers: { 'Content-Type': 'application/json' } }
  );

  if (!json?.success) {
    window.kilToast?.danger?.(json?.message || 'Failed to send OTP.');
    return false;
  }
  if (json.otp_id) otpIdHidden.value = json.otp_id;

  otpWrap.style.display = '';
  otpInput?.focus();
  countdown(resendBtn, 30);
  window.kilToast?.success?.(json?.message || 'OTP sent.', { duration: 0 });
  return true;
} catch (e) {
  console.log('sendOtp axios error:', e);
  window.kilToast?.danger?.(e?.response?.data?.message || 'Failed to send OTP.');
  return false;
}

  }

  // Resend handler
  resendBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const ok = await sendOtp();
    if(ok) window.kilToast?.success?.('OTP resent.');
  });

  // Main submit: first → OTP, second → final
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    otpErr.textContent = '';

    // FIRST submit → only send OTP (and DO NOT resend again next time)
    if(!isAwaitingOtp()){
      disable(submitBtn, true);
      const ok = await sendOtp();
      disable(submitBtn, false);
      if(ok){
        setAwaitingOtp(true);
        window.kilToast?.warning?.('Enter the OTP we sent, then submit again to complete signup.');
      }
      return;
    }

    // SECOND submit → finalize registration
    const code = (otpInput?.value || '').trim();
    if(!code){
      otpErr.textContent = 'Please enter the OTP.';
      window.kilToast?.warning?.('Please enter the OTP.');
      otpInput?.focus();
      return;
    }

    // Passwords (optional)
    const p1 = (pass1?.value || '').trim();
    const p2 = (pass2?.value || '').trim();
    if(p1 && p1 !== p2){
      window.kilToast?.warning?.('Password and confirm password do not match.');
      return;
    }

    // Prepare encrypted payload (mimic KWE)
    const fd     = new FormData(form);
    const payload = Object.fromEntries(fd.entries());

    const email = (emailInput?.value || '').trim();
    const cc    = (countryCodeEl?.value || '').trim();
    const num   = (contactEl?.value || '').trim();

    if(email) payload.email = encrypt(email);
    if(cc)    payload.country_code = encrypt(cc);
    if(num)   payload.contact = encrypt(num);
    if(p1)    payload.password = encrypt(p1);
    if(p2)    payload.confirm_password = encrypt(p2);
    payload.otp = encrypt(code);

    try{
      disable(submitBtn, true);

      // Use axios if present; fallback to fetch
       const fx = (window.axiosElaw) || window.axios || null;
          const fxFetch = window.kFetch || window.fetch;
      let json;
      if(fx?.post){
        const { data } = await fx.post('/superadmin/add_lawfirm', payload, {
          headers: { 'Accept':'application/json' },
          timeout: 20000
        });
        json = data;
      }else{
        const res = await fxFetch('/superadmin/add_lawfirm', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        json = await res.json();
      }

      if(!json?.success){
        const msg = json?.message || 'Registration failed.';
        otpErr.textContent = msg;
        window.kilToast?.danger?.(msg);
        return;
      }

      window.kilToast?.success?.('Registration complete. Logging you in…');
      location.assign(json.redirect || '/superadmin/view_lawfirms');

    }catch(err){
      const msg = err?.response?.data?.message || err?.message || 'Registration failed.';
      otpErr.textContent = msg;
      window.kilToast?.danger?.(msg);
    }finally{
      disable(submitBtn, false);
    }
  });

  // If user reloads via bfcache, keep OTP stage UI in sync
  window.addEventListener('pageshow', ()=>{
    if(isAwaitingOtp() && otpWrap) otpWrap.style.display = '';
  });
})();
</script>

