<!-- Header Start -->
<%- include('superheader.ejs'); %>
<!-- Header End -->

<!-- Sidebar -->
<%- include('supersidebar.ejs'); %>

<div class="page-wrapper">
  <div class="content">

    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between pb-3 mb-3 border-bottom flex-wrap gap-2">
      <div>
        <h4 class="fw-bold mb-0">Plan Catalog</h4>
        <div class="text-muted small">Define pricing & entitlements. Clean, safe, and validated by the feature registry.</div>
      </div>
      <div class="d-flex gap-2">
        <button id="btnRefresh" class="btn btn-outline-primary btn-sm">
          <i class="ti ti-refresh me-1"></i>Refresh
        </button>
      </div>
    </div>

    <div class="row">
      <!-- Left: Add / Edit -->
      <div class="col-12 col-lg-4 col-xxl-3 mb-4">
        <div class="card shadow-sm border-0 plan-card">
          <div class="card-header bg-white fw-semibold border-0 pb-0">
            <div class="d-flex align-items-center gap-2">
              <span class="plan-dot"></span>
              <span id="formTitle">Add Plan</span>
            </div>
            <div class="text-muted small mt-1">Solution is <code>core</code> (internal); clients see friendly names below.</div>
          </div>
          <div class="card-body">
            <form id="planForm" class="row g-3" autocomplete="off">
              <input type="hidden" id="plan_id">

              <!-- Friendly Product/Tier for admins (maps to solution_key & plan_key) -->
          

           
              <!-- Plan Key (unique per solution); becomes read-only on edit -->
<div class="col-12">
  <label class="form-label">Plan Key <span class="text-danger">*</span></label>
  <input data-kilvish-char="mix_,_-" type="text" id="plan_key" class="form-control"
         placeholder="e.g., free, pro, starter, business" required>
  <div class="form-text">Unique key per solution. Example: free, pro, starter, business.</div>
</div>

              <div class="col-12">
                <label class="form-label">Plan Name <span class="text-danger">*</span></label>
                <input data-ignore-kilvish="Yes" data-kilvish-char="mix_,_-_ _" type="text" id="name" class="form-control" placeholder="e.g., Free, Pro (Unlimited)" required>
              </div>

              <div class="col-6">
                <label class="form-label">Billing Period</label>
                <select id="billing_period" class="form-select" data-ignore-kilvish="Yes" >
                  <option value="monthly" selected>Monthly</option>
                  <option value="yearly">Yearly</option>
                  <option value="one_time">One-time</option>
                </select>
              </div>

              <div class="col-3">
                <label class="form-label">Currency</label>
                <select disabled id="price_currency" class="form-select">
                  <option value="<%= process.env.currency || 'JMD' %>" selected><%= process.env.currency || 'JMD' %></option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                  <option value="INR">INR</option>
                  <option value="GBP">GBP</option>
                  <option value="JPY">JPY</option>
                </select>
              </div>

              <div class="col-3">
                <label class="form-label">Amount</label>
                <input data-ignore-kilvish="Yes" type="number" step="0.001" id="price_amount" class="form-control" placeholder="0.00">
                <div class="form-text">Major units</div>
              </div>

              <!-- Features Panel (no JSON) -->
              <div class="col-12">
                <div class="border rounded-3 p-3">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="ti ti-settings"></i>
                    <div class="fw-semibold">Features</div>
                  </div>

                  <div id="featuresWrap" class="vstack gap-3">
                    <!-- Populated from registry -->
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Status</label>
                <select id="is_active" class="form-select">
                  <option value="1">Active</option>
                  <option value="0">Inactive</option>
                </select>
              </div>

              <div class="col-12 d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="btnSubmit">
                  <i class="ti ti-plus me-1"></i> <span id="submitLabel">Add Plan</span>
                </button>
                <button type="button" class="btn btn-outline-secondary d-none" id="btnCancelEdit">
                  <i class="ti ti-x me-1"></i>Cancel Edit
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: List -->
      <div class="col-12 col-lg-8 col-xxl-9">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 pb-0">
            <div class="d-flex align-items-center justify-content-between flex-column flex-md-row gap-2">
              <div class="fw-semibold d-flex align-items-center gap-2">
                <span class="plan-dot"></span> Plans
              </div>
              <div class="pa-search">
                <i class="ti ti-search"></i>
                <input data-kilvish-char="mix_,_-_ _" id="plan_search" type="text" class="form-control" placeholder="Search by name / tier…">
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr class="text-muted small">                  
                    <th>Tier</th>
                    <th>Name</th>
                    <th>Period</th>
                    <th class="text-end">Price</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="planTbody"></tbody>
              </table>
            </div>
            <div id="noData" class="text-center text-muted small d-none">No plans found.</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Footer -->
<%- include('superfooter.ejs'); %>

<style>
.plan-card{ border-radius:16px; overflow:hidden; }
.plan-dot{ width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,#22d3ee,#6366f1);display:inline-block; }
.pa-search{ position:relative; min-width:260px; }
.pa-search i{ position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#64748b; }
.pa-search input{ padding-left:36px; border-radius:10px; border:1px solid #e5e7eb; box-shadow:0 1px 2px rgba(16,24,40,.04); }
.badge-soft{ background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; font-weight:500; }
.badge-active { background:#d1fae5; color:#065f46; border:1px solid #a7f3d0; }
.badge-inactive { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
.feature-card{ border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
.form-switch .form-check-input { cursor: pointer; }
@media (max-width: 576px){
  .table td, .table th { white-space: nowrap; }
}
</style>

<script>
(function(){
  const fx = window.axiosElaw;
  const $  = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

  const tBody   = $('#planTbody');
  const noData  = $('#noData');
  const search  = $('#plan_search');

  const form    = $('#planForm');
  const plan_id = $('#plan_id');
  
  const ui_tier    = $('#ui_tier');
  const nameEl  = $('#name');
  const billing_period = $('#billing_period');
  const price_currency = $('#price_currency');
  const price_amount   = $('#price_amount');
  const is_active      = $('#is_active');
  const formTitle      = $('#formTitle');
  const submitLabel    = $('#submitLabel');
  const btnCancelEdit  = $('#btnCancelEdit');
  const btnRefresh     = $('#btnRefresh');
  const featuresWrap   = $('#featuresWrap');
  const plan_key = $('#plan_key');

  // Friendly mapping (UI only)


  // Currency exponent map (for decimal steps/format)
  const EXP = { JPY:0, KRW:0, VND:0, KWD:3, BHD:3, JOD:3, OMR:3, TND:3 }; // default 2

  const toMajor = (cur, minor)=> {
    const exp = (EXP[cur] ?? 2);
    return Number(minor || 0) / Math.pow(10, exp);
  };
  const fmtMoney = (cur, minor)=> {
    try { return new Intl.NumberFormat('en', { style:'currency', currency: cur }).format(toMajor(cur, minor)); }
    catch { return `${cur} ${toMajor(cur, minor).toFixed((EXP[cur] ?? 2))}`; }
  };

  // Registry rows from server (filtered to solution=core)
  let REGISTRY = [];
  // Loaded plans
  let rows = [];

  // Build feature inputs from registry (only the 4 features)
  function buildFeatureControls(values = {}) {
    featuresWrap.innerHTML = '';
    REGISTRY.forEach(def => {
      const current = values[def.key] ?? def.default;

      if (def.type === 'flag') {
        const checked = (String(current) === 'true' || current === true) ? 'checked' : '';
        featuresWrap.insertAdjacentHTML('beforeend', `
          <div class="feature-card">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">${def.label}</div>
                <div class="text-muted small">${def.description}</div>
              </div>
              <div class="form-check form-switch ms-3">
                <input class="form-check-input feat-flag" type="checkbox"
                  data-key="${def.key}" ${checked}>
              </div>
            </div>
          </div>
        `);
      } else if (def.type === 'limit') {
        const isUnlimited = Number(current) === -1;
        const numVal = isUnlimited ? '' : Number(current || 0);
        featuresWrap.insertAdjacentHTML('beforeend', `
          <div class="feature-card">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div>
                <div class="fw-semibold">${def.label}</div>
                <div class="text-muted small">${def.description}</div>
              </div>
              <div class="form-check form-switch ms-3">
                <input class="form-check-input feat-unlimited" type="checkbox"
                  data-key="${def.key}" ${isUnlimited ? 'checked' : ''}>
                <label class="form-check-label small ms-1">Unlimited</label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <input class="form-control feat-number" data-key="${def.key}" type="number" min="${def.min ?? 0}"
                placeholder="0" value="${numVal}" ${isUnlimited ? 'disabled' : ''} style="max-width: 160px;">
              <span class="text-muted small">Set a numeric cap, or mark Unlimited.</span>
            </div>
          </div>
        `);
      }
    });

    // Wire unlimited toggles → enable/disable number
    $$('.feat-unlimited').forEach(sw => {
      sw.addEventListener('change', () => {
        const key = sw.dataset.key;
        const input = $(`.feat-number[data-key="${key}"]`);
        if (sw.checked) {
          input.value = '';
          input.setAttribute('disabled', 'disabled');
        } else {
          input.removeAttribute('disabled');
          input.focus();
        }
      });
    });
  }

  function collectFeaturesFromUI() {
    const obj = {};
    // flags
    $$('.feat-flag').forEach(el => {
      obj[el.dataset.key] = el.checked;
    });
    // limits
    $$('.feat-number').forEach(el => {
      const key = el.dataset.key;
      const unlimited = $(`.feat-unlimited[data-key="${key}"]`).checked;
      if (unlimited) obj[key] = -1;
      else obj[key] = Math.max(0, Number(el.value || 0));
    });
    return obj;
  }

  async function loadRegistry() {
    const { data } = await fx.get('/superadmin/features_registry_json');
    if (!data?.success) throw new Error('Registry load failed');
    // Should already be only core entries
    REGISTRY = data.rows || [];
  }

  async function loadPlans() {
    const { data } = await fx.get('/superadmin/plans_json');
    if (!data?.success) throw new Error('Plans load failed');
    rows = data.rows || [];
  }

  function renderTable() {
    const q = (search.value||'').trim().toLowerCase();
    const filtered = rows.filter(r => {
      const tier = r.plan_key || '';
      const s = `${r.name} ${tier}`.toLowerCase();
      return s.includes(q);
    });
    tBody.innerHTML = filtered.map(r => rowHTML(r)).join('');
    noData.classList.toggle('d-none', filtered.length > 0);
  }

  function statusBadge(active){
    return active
      ? '<span class="badge bg-success-subtle text-success">Activated</span>'
      : '<span class="badge bg-danger-subtle text-danger">De-activated</span>';
  }

  function rowHTML(r){
    const price  = fmtMoney(r.price_currency, r.price_minor);
    return `
      <tr data-id="${r.plan_id}">
      
        <td><code>${r.plan_key}</code></td>
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.billing_period)}</td>
        <td class="text-end">${price}</td>
        <td>${statusBadge(!!r.is_active)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary me-1 act-preview" title="View"><i class="ti ti-eye"></i></button>
          <button class="btn btn-sm btn-outline-primary me-1 act-edit" title="Edit"><i class="ti ti-edit"></i></button>
          <button class="btn btn-sm btn-outline-${r.is_active ? 'warning' : 'success'} me-1 act-toggle" title="${r.is_active?'Deactivate':'Activate'}">
            <i class="ti ${r.is_active ? 'ti-player-pause' : 'ti-player-play'}"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger act-del" title="Delete"><i class="ti ti-trash"></i></button>
        </td>
      </tr>
    `;
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // ====== Submit (Add/Update)
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    try {
      const id = plan_id.value ? Number(plan_id.value) : null;

 const payload = {
  solution_key: 'core',  // internal
  plan_key: (plan_key.value || '').trim().toLowerCase(),  // now free text
  name: (nameEl.value || '').trim(),
  billing_period: billing_period.value,
  price_currency: price_currency.value,
  price_amount: Number(price_amount.value || 0),
  features_json: collectFeaturesFromUI(),
  is_active: Number(is_active.value) ? 1 : 0,
  plan_id: id || undefined
};
if (!payload.plan_key) { kilToast.danger('Plan key is required.'); return; }

      if (!payload.name) { kilToast.danger('Plan name is required.'); return; }

      const url = id ? '/superadmin/update_plan' : '/superadmin/add_plan';
      const { data } = await fx.post(url, payload);
      if (!data?.success) { kilToast.danger(data?.message || 'Save failed'); return; }

      kilToast.success(id ? 'Plan updated' : 'Plan created');
      clearForm();
      await loadPlans();
      renderTable();
    } catch (err) {
      kilToast.danger(err?.response?.data?.message || 'Save failed');
      console.error(err);
    }
  });


  function clearForm(){
  form.reset();
  plan_id.value = '';
  plan_key.removeAttribute('readonly');   // allow new key entry
  submitLabel.textContent = 'Add Plan';
  formTitle.textContent   = 'Add Plan';
  btnCancelEdit.classList.add('d-none');
  buildFeatureControls({});
}



  $('#btnCancelEdit').addEventListener('click', (e)=>{ e.preventDefault(); clearForm(); });

  // ====== Row Actions
  tBody.addEventListener('click', async (e)=>{
    const tr = e.target.closest('tr[data-id]');
    if (!tr) return;
    const id = Number(tr.getAttribute('data-id'));
    const row = rows.find(r => r.plan_id === id);
    if (!row) return;

    if (e.target.closest('.act-preview')) {
      await Swal.fire({
        title: escapeHtml(row.name),
        html: planPreviewHTML(row),
        width: 640,
        confirmButtonText: 'Close',
      });
      return;
    }


    if (e.target.closest('.act-edit')) {
  plan_id.value       = row.plan_id;
  plan_key.value      = row.plan_key;
  plan_key.setAttribute('readonly','readonly'); // lock key during edit

  nameEl.value        = row.name;
  billing_period.value= row.billing_period || 'monthly';
  price_currency.value= row.price_currency || '<%= process.env.CURRENCY || "JMD" %>';
  price_amount.value  = toMajor(row.price_currency, row.price_minor).toFixed((EXP[row.price_currency] ?? 2));
  is_active.value     = row.is_active ? '1' : '0';

  buildFeatureControls(row.features_json || {});
  submitLabel.textContent = 'Save Changes';
  formTitle.textContent   = `Edit Plan`;
  btnCancelEdit.classList.remove('d-none');
  return;
}

    if (e.target.closest('.act-toggle')) {
      try {
        const { isConfirmed } = await Swal.fire({
          icon: 'question',
          title: row.is_active ? 'Deactivate plan?' : 'Activate plan?',
          showCancelButton: true,
          confirmButtonText: 'Yes'
        });
        if (!isConfirmed) return;
        const { data } = await fx.post('/superadmin/toggle_plan_active', { id });
        if (!data?.success) return kilToast.danger(data?.message || 'Toggle failed');
        kilToast.success('Status updated');
        await loadPlans();
        renderTable();
      } catch (err) {
        kilToast.danger(err?.response?.data?.message || 'Toggle failed');
      }
      return;
    }

    if (e.target.closest('.act-del')) {
      const { isConfirmed } = await Swal.fire({
        icon: 'warning',
        title: 'Soft delete this plan?',
        text: 'You can restore it later from the database if needed.',
        showCancelButton: true,
        confirmButtonText: 'Delete',
        confirmButtonColor: '#d97706'
      });
      if (!isConfirmed) return;
      try {
        const { data } = await fx.post('/superadmin/delete_plan', { id });
        if (!data?.success) return kilToast.danger(data?.message || 'Delete failed');
        kilToast.success('Deleted');
        await loadPlans();
        renderTable();
      } catch (err) {
        kilToast.danger(err?.response?.data?.message || 'Delete failed');
      }
      return;
    }
  });

  function planPreviewHTML(r){
    const lines = [];
    (REGISTRY || []).forEach(def => {
      const v = (r.features_json || {})[def.key];
      if (def.type === 'flag') {
        lines.push(`<div><b>${escapeHtml(def.label)}:</b> ${v ? 'Enabled' : 'Disabled'}</div>`);
      } else {
        const val = (Number(v) === -1) ? 'Unlimited' : Number(v || 0);
        lines.push(`<div><b>${escapeHtml(def.label)}:</b> ${val}</div>`);
      }
    });
    return `
      <div class="text-start">       
        <div class="mb-2"><b>Tier:</b> ${escapeHtml(r.plan_key)}</div>
        <div class="mb-2"><b>Billing:</b> ${escapeHtml(r.billing_period)} · <b>Price:</b> ${fmtMoney(r.price_currency, r.price_minor)}</div>
        <div class="mb-2"><b>Status:</b> ${ (r.is_active ? 'Active' : 'De-activated') }</div>
        <hr/>
        <div class="vstack gap-1">${lines.join('')}</div>
      </div>
    `;
  }

  search.addEventListener('input', renderTable);
  btnRefresh.addEventListener('click', async (e)=>{ e.preventDefault(); await loadPlans(); renderTable(); kilToast.success('Refreshed'); });

  // ====== Init
  (async function init(){
    await loadRegistry();
    buildFeatureControls({});
    await loadPlans();
    renderTable();
  })();
})();
</script>
