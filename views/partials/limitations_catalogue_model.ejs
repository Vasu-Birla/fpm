<!-- firmstaff/partials/limitations_catalogue_modal.ejs -->

<div class="modal fade" id="limitationCatalogueModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0">
            <i class="ti ti-hourglass-high me-1"></i>
            Limitation Catalogue
          </h5>
          <% if (limitationView && limitationView.name) { %>
            <div class="small text-muted">
              <%= limitationView.name %>
            </div>
          <% } %>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <% if (!limitationView || !limitationView.categories || !limitationView.categories.length) { %>
          <div class="alert alert-info mb-0">
            Limitation catalogue not configured for this jurisdiction.
          </div>
        <% } else { %>

          <% if (limitationView.generalNotes && limitationView.generalNotes.length) { %>
            <ul class="small text-muted ps-3 mb-3">
              <% limitationView.generalNotes.forEach(function(note) { %>
                <li><%= note %></li>
              <% }); %>
            </ul>
          <% } %>

          <div class="accordion" id="limitationModalAccordion">
            <% limitationView.categories.forEach(function(cat, cIdx) {
                 const accId = 'limModalCat' + cIdx;
            %>
            <div class="accordion-item">
              <h2 class="accordion-header" id="<%= accId %>Heading">
                <button class="accordion-button <%= cIdx === 0 ? '' : 'collapsed' %>"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#<%= accId %>Body"
                        aria-expanded="<%= cIdx === 0 ? 'true' : 'false' %>"
                        aria-controls="<%= accId %>Body">
                  <span class="fw-semibold"><%= cat.categoryLabel %></span>
                </button>
              </h2>

              <div id="<%= accId %>Body"
                   class="accordion-collapse collapse <%= cIdx === 0 ? 'show' : '' %>"
                   aria-labelledby="<%= accId %>Heading"
                   data-bs-parent="#limitationModalAccordion">
                <div class="accordion-body">
                  <% if (cat.accrualRule) { %>
                    <p class="small text-muted mb-2">
                      <strong>Accrual Rule:</strong> <%= cat.accrualRule %>
                    </p>
                  <% } %>

                  <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 28%;">Claim</th>
                          <th style="width: 36%;">Description</th>
                          <th style="width: 20%;">Limitation Period</th>
                          <th style="width: 16%;">Trigger</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% cat.claims.forEach(function(claim) {
                             const label = claim.custom_label || claim.title;
                             const badgeClass =
                               claim.color_tag === 'danger' ? 'bg-danger-subtle text-danger' :
                               claim.color_tag === 'warning' ? 'bg-warning-subtle text-warning' :
                               claim.color_tag === 'success' ? 'bg-success-subtle text-success' :
                               claim.color_tag === 'info' ? 'bg-info-subtle text-info' :
                               'bg-secondary-subtle text-secondary';
                        %>
                        <tr>
                          <td>
                            <div class="fw-semibold"><%= label %></div>
                            <% if (claim.statutoryReference) { %>
                              <div class="small text-muted"><%= claim.statutoryReference %></div>
                            <% } %>
                            <% if (claim.warning_days_before) { %>
                              <span class="badge <%= badgeClass %> mt-1">
                                Warn <%= claim.warning_days_before %> days before
                              </span>
                            <% } %>
                          </td>
                          <td class="small">
                            <%= claim.description %>
                            <% if (claim.specialNotes) { %>
                              <div class="mt-1 text-muted">
                                <strong>Note:</strong> <%= claim.specialNotes %>
                              </div>
                            <% } %>
                          </td>
                          <td class="small">
                            <%= claim.timeLimitText || (claim.timeLimitYears ? (claim.timeLimitYears + ' years') : 'As per statute / court') %>
                          </td>
                          <td class="small">
                            <%= claim.triggerEventLabel || '' %>
                          </td>
                        </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>

                </div>
              </div>
            </div>
            <% }); %>
          </div>
        <% } %>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
